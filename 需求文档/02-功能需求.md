# Chips Viewer - 功能需求

**版本**: 2.0.0  
**更新时间**: 2026-01-31  
**状态**: 正式版

---

## 1. 核心功能概述

Chips Viewer 的核心功能分为四大模块：

1. **卡片渲染系统**：解析和渲染各种类型的卡片内容
2. **箱子展示系统**：按照布局方式展示箱子中的卡片集合
3. **查看工具插件系统**：加载和管理各种文件查看工具插件
4. **用户交互系统**：提供导航、搜索、主题切换等功能

**重要原则**：
- 所有查看工具来自**公共基础层（Chips Foundation）**
- 查看器通过**微内核路由**调用这些工具
- 查看器负责调度和组织，不重新实现工具
- 插件可以扩展或替换默认查看工具

---

## 2. 卡片渲染功能

### 2.1 卡片渲染架构说明

**核心原则** ⭐⭐⭐：
- **卡片渲染的完整逻辑在公共基础层**（CardRenderer、BaseCardRenderers、BoxRenderer、ThemeEngine）
- **Viewer 通过路由调用 CardRenderer**，不自己实现渲染逻辑
- **渲染流程**：渲染器读取卡片配置 → 调用基础卡片插件的前端代码 → 填充内容数据 → 生成 iframe
- **每个基础卡片一个 iframe**，多个 iframe 垂直排列组合成完整卡片
- **最终交付一个大 iframe 窗口**（菜单栏 + 基础卡片 iframes + 主题背景）

**工作流程**：
```
用户打开卡片
    ↓
查看器通过路由请求内核：打开卡片
    ↓
内核通过路由调用 CardRenderer（公共基础层）
    ↓
CardRenderer 解析卡片文件
  - 读取 metadata.yaml、structure.yaml
  - 读取 content/ 目录下的配置文件
    ↓
CardRenderer 逐个渲染基础卡片
  - 根据类型调用对应的 BaseCardRenderer
  - BaseCardRenderer 调用基础卡片插件的前端代码
  - 将配置数据填充到前端模板
  - 生成 iframe 窗口
    ↓
CardRenderer 组合所有 iframe
  - 垂直排列所有基础卡片的 iframe
  - 添加菜单栏
  - 应用卡片级主题（通过 ThemeEngine）
  - 生成完整的大 iframe 窗口
    ↓
返回渲染结果给查看器（通过路由）
    ↓
查看器将大 iframe 显示给用户
```

**关键点**：
- 查看器**不实现渲染逻辑**，只调用 CardRenderer
- **CardRenderer 在公共基础层**，处理完整渲染流程
- **基础卡片插件包含前端代码**（HTML结构、JS交互逻辑）
- **卡片文件保存内容数据**（配置文件）
- **渲染器 = 调用插件前端 + 填充数据 → 生成 iframe**
- 查看器负责**窗口管理、导航控制、用户交互扩展**

### 2.2 基础卡片查看（通过 CardRenderer）

**重要说明**：
- **所有基础卡片的渲染都由 CardRenderer（公共基础层）完成**
- 查看器**不直接调用**单个基础卡片的渲染器
- 查看器**调用 CardRenderer**，由它负责完整的渲染流程

**调用方式**：
```typescript
// 查看器通过路由请求 CardRenderer 渲染整个卡片
const response = await Core.request({
  service: 'foundation.card.render',
  payload: {
    card_id: 'abc123',
    container_id: 'viewer-content-area',
    options: {
      theme_id: currentTheme,
      interactive: true,
      readonly: true
    }
  }
});

// CardRenderer 返回渲染结果（大 iframe 窗口）
const cardFrame = response.data.frame;
```

**CardRenderer 的渲染流程**（由基础层处理）：
1. 解析卡片文件（metadata.yaml、structure.yaml、content/）
2. 遍历所有基础卡片，按顺序渲染
3. 对于每个基础卡片：
   - 根据类型调用对应的 BaseCardRenderer
   - BaseCardRenderer 调用基础卡片插件的前端代码
   - 将配置数据填充到前端模板
   - 生成 iframe 窗口
4. 组合所有 iframe（垂直排列）
5. 添加菜单栏和卡片级主题背景
6. 返回完整的大 iframe 窗口

**支持的基础卡片类型**（所有26种）：
- 富文本、Markdown、图片、视频、音频
- 代码、列表、打分、网页、PDF
- 文本、3D模型等

**性能要求**：
- 普通卡片渲染时间 < 500ms
- 大型卡片（多个基础卡片）< 1s
- 使用基础层的优化（虚拟渲染、增量更新、懒加载）

### 2.3 基础卡片的具体支持

**所有基础卡片类型都由 CardRenderer 统一处理**，包括：

1. **富文本卡片**：粗体、斜体、链接、列表等格式化文本
2. **Markdown 卡片**：Markdown 语法、代码高亮、数学公式、目录生成
3. **图片卡片**：JPEG、PNG、GIF、WebP、SVG等，支持缩放、旋转、幻灯片
4. **视频卡片**：MP4、WebM、MOV等，支持播放控制、字幕、倍速播放
5. **音频卡片**：MP3、WAV、FLAC等，支持可视化、歌词显示
6. **代码卡片**：100+编程语言的语法高亮、行号、代码折叠
7. **列表卡片**：无序列表、有序列表、任务列表
8. **打分卡片**：星级评分、数字评分、进度条评分
9. **网页卡片**：iframe嵌入、网页快照、链接预览
10. **PDF 卡片**：PDF渲染、页面导航、文本搜索
11. **文本卡片**：纯文本显示、搜索、自动换行
12. **3D 模型卡片**：OBJ、GLTF等3D模型的显示和交互
13. **其他基础卡片**：等26种基础卡片类型

**查看器的职责**：
- 通过路由调用 CardRenderer
- 接收渲染结果（iframe 窗口）
- 将 iframe 嵌入到界面中
- 提供窗口管理、导航控制等交互功能

**CardRenderer 的职责**（由公共基础层处理）：
- 解析卡片文件结构
- 调用基础卡片插件的前端代码
- 填充内容数据
- 生成并组合 iframe
- 应用主题样式
- 返回完整的渲染结果

---

## 3. 复合卡片渲染

### 3.1 复合卡片渲染说明

**核心原则**：
- **复合卡片的渲染由 CardRenderer 统一处理**
- CardRenderer 自动处理卡片的嵌套结构
- 查看器只需调用一次 CardRenderer，传入卡片 ID

**工作流程**：
```
查看器请求渲染卡片（card_id）
    ↓
CardRenderer（公共基础层）接收请求
    ↓
解析卡片文件结构（structure.yaml）
    ↓
识别这是复合卡片（包含多个基础卡片）
    ↓
按顺序渲染每个基础卡片
  - 调用基础卡片插件的前端代码
  - 填充配置数据
  - 生成 iframe 窗口
    ↓
垂直排列所有 iframe
    ↓
添加菜单栏和卡片级主题背景
    ↓
返回完整的大 iframe 窗口
    ↓
查看器显示这个大 iframe
```

**CardRenderer 自动处理的功能**：
- 解析卡片嵌套结构
- 遍历并渲染所有基础卡片
- 组织 iframe 布局（垂直堆叠）
- 应用主题样式
- 性能优化（虚拟滚动、懒加载、缓存）

**查看器的职责**：
- 提供导航控制（前进/后退、面包屑）
- 提供窗口管理（最小化、全屏、分屏）
- 提供用户交互扩展（收藏、搜索）

### 3.2 卡片嵌套展示

**说明**：
- 卡片嵌套由 CardRenderer 自动识别和处理
- 查看器提供导航辅助功能

**查看器提供的导航功能**：
- 面包屑导航（显示当前位置）
- 卡片树形结构侧边栏
- 快速跳转到父卡片/子卡片
- 显示卡片引用关系
- 支持多窗口查看（分屏）

---

## 4. 箱子展示功能

### 4.1 箱子渲染说明

**核心原则**：
- **箱子的渲染由 BoxRenderer（公共基础层）完成**
- 查看器通过路由调用 BoxRenderer
- BoxRenderer 负责加载布局插件并渲染箱子界面

**工作流程**：
```
用户打开箱子
    ↓
查看器通过路由请求 BoxRenderer
    ↓
BoxRenderer（公共基础层）接收请求
    ↓
解析箱子文件
  - 读取 .box/metadata.yaml
  - 读取 .box/structure.yaml（卡片列表）
  - 读取 .box/content.yaml（布局配置）
    ↓
识别布局类型（网格、瀑布流、列表、看板等）
    ↓
加载对应的布局插件
    ↓
布局插件生成展示界面
  - 调用布局插件的前端代码
  - 传入卡片列表和布局配置
  - 生成展示网页
    ↓
返回渲染结果（iframe 窗口）
    ↓
查看器显示箱子界面
    ↓
用户点击某个卡片项时
    ↓
查看器调用 CardRenderer 渲染该卡片
```

**调用方式**：
```typescript
// 查看器通过路由请求 BoxRenderer 渲染箱子
const response = await Core.request({
  service: 'foundation.box.render',
  payload: {
    box_id: 'xyz789',
    container_id: 'viewer-content-area',
    options: {
      theme_id: currentTheme,
      interactive: true
    }
  }
});

// BoxRenderer 返回渲染结果（iframe 窗口）
const boxFrame = response.data.frame;

// 用户点击卡片时，查看器调用 CardRenderer
const cardResponse = await Core.request({
  service: 'foundation.card.render',
  payload: {
    card_id: selectedCardId,
    container_id: 'card-viewer-area',
    options: { theme_id: currentTheme }
  }
});
```

### 4.2 布局展示

**说明**：
- **所有布局由 BoxRenderer 调用布局插件实现**
- 布局插件包含完整的前端代码（HTML、CSS、JS）
- BoxRenderer 传入卡片列表和配置，布局插件生成展示界面

**支持的布局类型**（通过布局插件提供）：

#### 4.2.1 网格布局
- 固定列数的网格排列
- 响应式网格（根据窗口宽度自动调整列数）
- 卡片预览（缩略图 + 标题）
- 自动缩略图生成

#### 4.2.2 瀑布流布局
- 动态高度（根据内容自动调整）
- 智能填充空白区域
- 针对图片内容优化
- 懒加载和虚拟滚动

#### 4.2.3 列表布局
- 单列垂直排列
- 详细信息显示（标题、描述、创建时间、大小）
- 支持排序（名称、时间、大小）
- 紧凑模式和详细模式切换

#### 4.2.4 看板布局
- 泳道展示（按状态/分类分组）
- 显示卡片排列顺序
- 状态标识和进度显示
- 支持折叠和展开分组

**查看器的职责**：
- 调用 BoxRenderer 获取箱子渲染结果
- 提供箱子级别的导航和筛选功能
- 处理用户点击卡片项的交互

### 4.3 箱子导航

**浏览控制**：
- 翻页功能（上一页/下一页）
- 跳转功能（直接跳转到指定页）
- 全屏浏览模式
- 幻灯片模式（自动播放）

**筛选和搜索**：
- 关键词搜索（搜索卡片标题和内容）
- 标签筛选（按标签过滤）
- 类型筛选（按卡片类型过滤）
- 时间筛选（按创建/修改时间筛选）
- 组合筛选（多条件同时应用）

**排序功能**：
- 按名称排序（A-Z、Z-A）
- 按创建时间排序（最新、最旧）
- 按修改时间排序
- 按文件大小排序
- 自定义排序

### 4.4 箱子信息

**元数据显示**：
- 箱子名称和描述
- 卡片数量和总大小
- 创建时间和修改时间
- 作者信息（如果有）
- 标签和分类

**统计信息**：
- 卡片类型分布（饼图或柱状图）
- 内容大小分布
- 创建时间分布
- 标签使用统计

---

## 5. 查看工具插件系统

### 5.1 插件管理功能

#### 5.1.1 插件发现
- 系统默认插件（预装的基础查看工具）
- 插件市场浏览和搜索
- 本地安装（从文件安装）
- 插件推荐（根据查看的内容类型）

#### 5.1.2 插件安装

**工作流程**：
```
用户选择插件
    ↓
查看器通过路由请求内核安装插件
    ↓
内核下载插件包
    ↓
验证插件签名和权限
    ↓
解压并安装插件文件
    ↓
注册插件到系统
    ↓
初始化插件
    ↓
安装完成，通知查看器
```

**调用方式**：
```typescript
const result = await Core.request({
  service: 'plugin.install',
  payload: {
    source: 'https://market.chips.com/plugins/pro-video-player.zip',
    auto_enable: true
  }
});
```

**功能**：
- 一键安装
- 版本管理（安装特定版本）
- 依赖检查（自动安装依赖）
- 安装进度显示
- 安装验证（完整性和安全性）

#### 5.1.3 插件更新
- 自动检查更新
- 版本比对
- 更新日志显示
- 一键更新
- 批量更新所有插件

#### 5.1.4 插件卸载
- 安全卸载（完全删除文件和配置）
- 依赖检查（提示是否有其他插件依赖）
- 数据清理（可选清理插件产生的数据）
- 卸载确认（防止误删）

### 5.2 插件配置

#### 5.2.1 默认工具设置
- 为每种文件格式设置默认查看工具
- 设置工具的优先级
- 定义自动选择规则

**示例**：
```yaml
# 默认查看工具配置
default_tools:
  video/mp4: 'chipshub:video-player-default'
  audio/mp3: 'chipshub:audio-player-default'
  image/jpeg: 'chipshub:image-viewer-default'
  text/x-python: 'chipshub:code-viewer-default'
```

#### 5.2.2 插件参数配置
- 全局配置（影响所有内容）
- 文件类型配置（针对特定类型）
- 单文件配置（针对单个文件）
- 配置导入/导出

### 5.3 插件调度

#### 5.3.1 插件选择算法

**工作流程**：
```
查看器需要查看特定文件（如 video.mp4）
    ↓
查看器通过路由请求内核：查找支持 video/mp4 的插件
    ↓
内核查询插件注册表，返回所有支持的插件列表
    ↓
查看器应用选择策略：
  1. 检查是否有用户设置的默认插件
  2. 如果有，选择默认插件
  3. 如果没有，选择系统默认插件
  4. 如果系统默认插件不可用，选择第一个可用插件
    ↓
查看器通过路由调用选中的插件
    ↓
插件渲染内容
```

**选择策略**：
- 用户设置优先
- 系统默认次之
- 性能考虑（优先选择性能较好的插件）
- 降级处理（插件不可用时使用备用方案）

#### 5.3.2 插件加载
- 按需加载（只加载当前需要的插件）
- 懒加载（延迟加载非关键插件）
- 预加载（预测用户需求，提前加载）
- 卸载机制（长时间不用自动卸载）

#### 5.3.3 插件通信

**所有通信通过微内核路由**：
```typescript
// 查看器调用插件
const pluginResult = await Core.request({
  service: 'plugin.invoke',
  payload: {
    plugin_id: 'chipshub:video-player-default',
    method: 'render',
    params: {
      video_uri: 'chips://card/abc123/video.mp4',
      container_id: 'player-container',
      options: { autoplay: false }
    }
  }
});

// 插件调用基础层
const foundationResult = await Core.request({
  service: 'foundation.video.create_player',
  payload: {
    // ...
  }
});
```

---

## 6. 用户交互功能

### 6.1 导航控制

**返回/前进**：
- 浏览历史记录
- 键盘快捷键（Alt + ←/→）
- 工具栏按钮

**面包屑导航**：
- 显示当前位置层级
- 点击任一层级快速跳转
- 自动截断过长路径

**侧边栏导航**：
- 卡片树形结构
- 展开/折叠节点
- 搜索节点
- 拖拽排序

**书签功能**：
- 标记常用位置
- 快速访问书签
- 书签管理（编辑、删除、排序）

### 6.2 缩放控制

**页面缩放**：
- Ctrl +/- 或手势缩放
- 缩放比例：50% - 200%
- 重置为 100%

**内容缩放**（针对图片、视频、PDF）：
- 独立于页面缩放
- 适应窗口/原始大小切换
- 支持精确缩放比例设置

### 6.3 搜索功能

**全局搜索**：
```typescript
const searchResult = await Core.request({
  service: 'search.global',
  payload: {
    query: '搜索关键词',
    scope: 'current_box',  // current_card | current_box | all
    filters: {
      card_types: ['video', 'image'],
      date_range: {
        from: '2026-01-01',
        to: '2026-01-31'
      }
    }
  }
});
```

**页内搜索**：
- 搜索当前卡片内容（Ctrl+F）
- 高亮显示搜索结果
- 在搜索结果间跳转（Enter/Shift+Enter）
- 显示匹配数量

### 6.4 主题管理

**主题切换**：
```typescript
await Core.request({
  service: 'theme.apply',
  payload: {
    theme_id: 'chipshub:dark-theme',
    scope: 'global'  // global | current_card
  }
});
```

**主题选项**：
- 内置主题（简洁白、深邃黑、护眼绿等）
- 第三方主题（从市场安装）
- 自定义主题（创建和编辑）

**自动切换**：
- 跟随系统（自动适应操作系统明暗模式）
- 定时切换（根据时间自动切换）
- 平滑过渡（主题切换动画）

### 6.5 键盘快捷键

**导航快捷键**：
- 方向键：上/下/左/右移动
- Page Up/Down：翻页
- Home/End：跳到开头/结尾
- Alt + ←/→：后退/前进

**功能快捷键**：
- Ctrl/Cmd + F：搜索
- Ctrl/Cmd + +/-：缩放
- Ctrl/Cmd + 0：重置缩放
- F11：全屏
- F5：刷新
- Esc：退出全屏/取消操作

**播放控制**：
- Space：播放/暂停
- ←/→：快退/快进
- ↑/↓：音量调节
- M：静音

**自定义快捷键**：
- 用户可以自定义所有快捷键
- 导入/导出快捷键配置

### 6.6 触控手势（移动端）

**基础手势**：
- 滑动：左右滑动切换卡片
- 捏合：双指缩放
- 双击：放大/缩小
- 长按：显示上下文菜单

**高级手势**：
- 三指滑动：快速切换
- 边缘滑动：打开侧边栏
- 旋转：旋转图片/模型

---

## 7. 辅助功能

### 7.1 元数据显示

**文件信息**：
- 文件名、大小、格式
- 文件路径
- 创建和修改时间

**卡片信息**：
- 卡片 ID（10 位 62 进制）
- 卡片名称和描述
- 作者信息
- 标签和分类
- 主题设置

**统计信息**：
- 字数（文本卡片）
- 播放时长（视频/音频）
- 分辨率（图片/视频）
- 代码行数（代码卡片）

### 7.2 分享功能

**导出功能**：
```typescript
await Core.request({
  service: 'card.export',
  payload: {
    card_id: 'abc123',
    format: 'pdf',  // pdf | html | image | markdown
    export_path: '/path/to/export',
    options: {
      include_styles: true,
      include_resources: true
    }
  }
});
```

**分享选项**：
- 生成分享链接（如果支持）
- 导出为 PDF
- 导出为 HTML
- 导出为图片
- 生成二维码（移动端扫描）
- 嵌入代码（网页嵌入）

### 7.3 辅助工具

**打印功能**：
- 打印预览
- 页面设置
- 选择打印范围

**朗读功能**：
```typescript
await Core.request({
  service: 'tts.read',  // Text-to-Speech
  payload: {
    text: cardContent,
    language: 'zh-CN',
    voice: 'female',
    rate: 1.0
  }
});
```

**翻译功能**：
- 集成翻译工具
- 划词翻译
- 全文翻译

**批注显示**：
- 显示只读批注
- 批注高亮
- 批注列表

---

## 8. 性能要求

### 8.1 启动性能

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 冷启动 | < 2 秒 | 应用启动到主界面可见 |
| 热启动 | < 1 秒 | 再次启动应用 |
| 文件关联启动 | < 2.5 秒 | 双击文件到内容显示 |

### 8.2 运行性能

**内存占用**：
- 空闲状态：< 200MB
- 查看普通卡片：< 500MB
- 查看大型卡片（视频等）：< 1GB
- 内存泄漏：0 容忍

**CPU 占用**：
- 空闲状态：< 5%
- 普通查看：< 20%
- 视频播放：< 40%
- 大文件处理：< 60%

### 8.3 响应性能

| 操作 | 目标值 |
|------|--------|
| 卡片打开 | < 500ms |
| 页面切换 | < 200ms |
| 搜索响应 | < 100ms |
| 界面交互 | < 16ms（60fps）|
| 主题切换 | < 100ms |
| 插件加载 | < 200ms |

### 8.4 渲染性能

**帧率要求**：
- 滚动：≥ 60fps
- 动画：≥ 60fps
- 视频播放：≥ 30fps（或原始帧率）

**优化策略**（由基础层和查看器协作提供）：
- 虚拟滚动（长列表）
- 懒加载（图片、视频）
- 增量渲染（分批渲染）
- 硬件加速（CSS transforms、WebGL）
- Web Worker（计算密集任务）

---

## 9. 兼容性要求

### 9.1 平台支持

**桌面端**：
- Windows 10+
- macOS 10.13+
- Linux（Ubuntu 20.04+、Fedora 35+、Debian 11+）

**移动端**（未来）：
- iOS 13+
- Android 8.0+

**Web 端**（未来）：
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 9.2 文件格式兼容

**卡片格式**：
- 完整支持 Chips 卡片文件格式规范（v1.0）
- 向后兼容旧版本卡片文件
- 不支持的功能优雅降级

**媒体格式**：
- 所有格式由基础层查看工具支持
- 查看器不限制格式
- 可通过插件扩展更多格式

### 9.3 向后兼容

**版本策略**：
- 查看器版本遵循语义化版本规范
- 主版本更新可能破坏兼容性
- 次版本更新保持向后兼容
- 修订版本仅修复问题

---

## 10. 总结

Chips Viewer 的功能设计遵循以下核心原则：

1. **基于公共基础层**：
   - 所有查看工具由基础层提供
   - 通过微内核路由调用
   - 零重复开发，统一维护

2. **插件化架构**：
   - 查看工具都是插件
   - 用户可以扩展和替换
   - 形成开放的生态系统

3. **中心路由通信**：
   - 所有模块间通信通过内核
   - 完全解耦，可替换
   - 统一的权限和日志管理

4. **优秀的用户体验**：
   - 快速响应，流畅交互
   - 丰富的功能，专业的工具
   - 跨平台支持，一致体验

通过这些功能，Chips Viewer 为用户提供了完整、专业、高效的卡片查看体验。

---

**文档维护者**：Chips 生态团队  
**审核状态**：✅ 已审核  
**下一步**：阅读[用户故事文档](./03-用户故事.md)了解使用场景

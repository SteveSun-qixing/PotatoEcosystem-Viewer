# 开源工具集成

## 1. 集成概述

Chips Viewer 中的查看工具插件大量使用成熟的开源方案，既能加快开发速度,又能保证质量和稳定性。本文档详细说明所有使用的开源工具、集成方式和注意事项。

### 1.1 选择原则

选择开源工具时遵循以下原则：

1. **成熟稳定**：有活跃的社区和长期维护
2. **功能完整**：满足查看器的功能需求
3. **性能优秀**：高效、流畅,资源占用合理
4. **许可友好**：使用宽松的开源协议（MIT、Apache 2.0 等）
5. **易于集成**：API 简洁,文档完善
6. **体积适中**：不引入过大的依赖

### 1.2 许可证合规

所有使用的开源工具必须：
- 在软件中声明使用的开源库及其许可证
- 遵守各个开源协议的要求
- 在关于页面列出所有开源依赖

## 2. 视频播放器

### 2.1 Video.js

**官网**: https://videojs.com/  
**GitHub**: https://github.com/videojs/video.js  
**许可证**: Apache License 2.0  
**版本**: 8.x

#### 2.1.1 简介

Video.js 是一个开源的 HTML5 视频播放器,支持桌面和移动设备,提供了丰富的功能和插件生态。

#### 2.1.2 核心功能

- 支持 HTML5 video 标签
- 自适应布局和响应式设计
- 支持多种视频格式（MP4、WebM、Ogg）
- 完整的播放控制
- 字幕支持
- 插件系统
- 主题定制

#### 2.1.3 集成方式

```typescript
import videojs from 'video.js';
import 'video.js/dist/video-js.css';

// 创建播放器
const player = videojs('my-video', {
  controls: true,
  autoplay: false,
  preload: 'auto',
  fluid: true,
  responsive: true
});

// 设置视频源
player.src({
  type: 'video/mp4',
  src: 'video.mp4'
});

// 监听事件
player.on('play', () => {
  console.log('Video is playing');
});

// 清理
player.dispose();
```

#### 2.1.4 常用插件

**videojs-contrib-quality-levels**  
- 多清晰度支持
- https://github.com/videojs/videojs-contrib-quality-levels

**videojs-subtitle-octopus**  
- 高级字幕支持（ASS/SSA）
- https://github.com/Dador/videojs-subtitle-octopus

**videojs-hotkeys**  
- 键盘快捷键支持
- https://github.com/ctd1500/videojs-hotkeys

#### 2.1.5 定制配置

```typescript
const playerOptions = {
  // 基础配置
  controls: true,
  autoplay: false,
  preload: 'auto',
  
  // 布局
  fluid: true,
  aspectRatio: '16:9',
  
  // 播放配置
  playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 2],
  
  // 控制栏
  controlBar: {
    children: [
      'playToggle',
      'volumePanel',
      'currentTimeDisplay',
      'timeDivider',
      'durationDisplay',
      'progressControl',
      'playbackRateMenuButton',
      'qualitySelector',
      'fullscreenToggle'
    ]
  },
  
  // 语言
  language: 'zh-CN',
  
  // 错误处理
  errorDisplay: true
};
```

### 2.2 Plyr

**官网**: https://plyr.io/  
**GitHub**: https://github.com/sampotts/plyr  
**许可证**: MIT License  
**版本**: 3.x

#### 2.2.1 简介

Plyr 是一个简洁、轻量级的媒体播放器,界面美观,易于使用。

#### 2.2.2 集成方式

```typescript
import Plyr from 'plyr';
import 'plyr/dist/plyr.css';

const player = new Plyr('#player', {
  controls: [
    'play-large',
    'play',
    'progress',
    'current-time',
    'duration',
    'mute',
    'volume',
    'settings',
    'fullscreen'
  ],
  settings: ['quality', 'speed'],
  i18n: {
    // 中文本地化
  }
});
```

## 3. 音频播放器

### 3.1 Howler.js

**官网**: https://howlerjs.com/  
**GitHub**: https://github.com/goldfire/howler.js  
**许可证**: MIT License  
**版本**: 2.x

#### 3.1.1 简介

Howler.js 是一个现代化的音频库,提供了可靠的跨平台音频播放功能。

#### 3.1.2 核心功能

- 跨浏览器兼容
- 多音频格式支持
- 空间音频（3D 音效）
- 播放队列管理
- 音频精灵（Audio Sprite）
- 自动缓存

#### 3.1.3 集成方式

```typescript
import { Howl, Howler } from 'howler';

// 创建音频实例
const sound = new Howl({
  src: ['audio.mp3', 'audio.ogg'],
  html5: true,
  preload: true,
  
  // 事件监听
  onload: () => console.log('Loaded'),
  onplay: () => console.log('Playing'),
  onend: () => console.log('Ended'),
  onerror: (id, error) => console.error('Error:', error)
});

// 播放控制
sound.play();
sound.pause();
sound.stop();
sound.seek(30); // 跳转到 30 秒
sound.volume(0.5); // 设置音量

// 全局设置
Howler.volume(0.8);
Howler.mute(true);
```

#### 3.1.4 高级功能

```typescript
// 音频可视化
const analyser = Howler.ctx.createAnalyser();
analyser.fftSize = 256;
const dataArray = new Uint8Array(analyser.frequencyBinCount);

// 连接分析器
Howler.masterGain.connect(analyser);

// 获取频谱数据
function getVisualizationData() {
  analyser.getByteFrequencyData(dataArray);
  return dataArray;
}
```

### 3.2 WaveSurfer.js

**官网**: https://wavesurfer-js.org/  
**GitHub**: https://github.com/katspaugh/wavesurfer.js  
**许可证**: BSD-3-Clause License  
**版本**: 7.x

#### 3.2.1 简介

WaveSurfer.js 提供了音频波形可视化功能,适合需要精确控制的音频应用。

#### 3.2.2 集成方式

```typescript
import WaveSurfer from 'wavesurfer.js';

const wavesurfer = WaveSurfer.create({
  container: '#waveform',
  waveColor: '#4A90E2',
  progressColor: '#1E5BA8',
  height: 128,
  responsive: true,
  normalize: true
});

// 加载音频
await wavesurfer.load('audio.mp3');

// 播放控制
wavesurfer.play();
wavesurfer.pause();
wavesurfer.seekTo(0.5); // 跳转到中间

// 事件
wavesurfer.on('ready', () => console.log('Ready'));
wavesurfer.on('finish', () => console.log('Finished'));
```

#### 3.2.3 插件

**wavesurfer.js/regions**
```typescript
import RegionsPlugin from 'wavesurfer.js/dist/plugins/regions.js';

const regions = wavesurfer.registerPlugin(RegionsPlugin.create());

// 添加区域
regions.addRegion({
  start: 10,
  end: 20,
  color: 'rgba(255, 0, 0, 0.3)',
  drag: true,
  resize: true
});
```

## 4. 图片查看器

### 4.1 Viewer.js

**官网**: https://fengyuanchen.github.io/viewerjs/  
**GitHub**: https://github.com/fengyuanchen/viewerjs  
**许可证**: MIT License  
**版本**: 1.x

#### 4.1.1 简介

Viewer.js 是一个强大的图片查看器,支持缩放、旋转、导航等功能。

#### 4.1.2 核心功能

- 缩放（拖拽、滚轮、手势）
- 旋转和翻转
- 图片导航
- 全屏查看
- 键盘快捷键
- 触摸手势支持

#### 4.1.3 集成方式

```typescript
import Viewer from 'viewerjs';
import 'viewerjs/dist/viewer.css';

// 单图模式
const viewer = new Viewer(document.getElementById('image'), {
  inline: false,
  button: true,
  navbar: false,
  title: true,
  toolbar: {
    zoomIn: true,
    zoomOut: true,
    oneToOne: true,
    reset: true,
    rotateLeft: true,
    rotateRight: true,
    flipHorizontal: true,
    flipVertical: true
  },
  
  // 事件
  viewed: () => console.log('Viewed'),
  zoom: (e) => console.log('Zoom:', e.detail.ratio)
});

// 显示查看器
viewer.show();
```

#### 4.1.4 画廊模式

```typescript
// 多图模式
const gallery = new Viewer(document.getElementById('gallery'), {
  navbar: true,
  toolbar: true,
  
  // 幻灯片
  transition: true,
  loop: true,
  
  // 缩略图
  tooltip: true
});
```

### 4.2 PhotoSwipe

**官网**: https://photoswipe.com/  
**GitHub**: https://github.com/dimsemenov/PhotoSwipe  
**许可证**: MIT License  
**版本**: 5.x

#### 4.2.1 简介

PhotoSwipe 是一个无依赖的 JavaScript 图片画廊,特别适合移动设备。

#### 4.2.2 集成方式

```typescript
import PhotoSwipeLightbox from 'photoswipe/lightbox';
import 'photoswipe/style.css';

const lightbox = new PhotoSwipeLightbox({
  gallery: '#gallery',
  children: 'a',
  pswpModule: () => import('photoswipe'),
  
  // 配置
  bgOpacity: 0.9,
  spacing: 0.1,
  allowPanToNext: true,
  loop: false,
  
  // 缩放
  maxZoomLevel: 5,
  pinchToClose: true
});

lightbox.init();
```

## 5. 代码查看器

### 5.1 Prism.js

**官网**: https://prismjs.com/  
**GitHub**: https://github.com/PrismJS/prism  
**许可证**: MIT License  
**版本**: 1.x

#### 5.1.1 简介

Prism 是一个轻量级、可扩展的语法高亮库。

#### 5.1.2 核心功能

- 支持 200+ 编程语言
- 多种主题
- 插件系统
- 自动高亮
- 行号、代码折叠等功能

#### 5.1.3 集成方式

```typescript
import Prism from 'prismjs';

// 导入语言
import 'prismjs/components/prism-javascript';
import 'prismjs/components/prism-typescript';
import 'prismjs/components/prism-python';

// 导入主题
import 'prismjs/themes/prism-tomorrow.css';

// 导入插件
import 'prismjs/plugins/line-numbers/prism-line-numbers';
import 'prismjs/plugins/line-numbers/prism-line-numbers.css';

// 高亮代码
const code = document.querySelector('code.language-javascript');
Prism.highlightElement(code);

// 或高亮所有
Prism.highlightAll();
```

#### 5.1.4 常用插件

```typescript
// 行号
import 'prismjs/plugins/line-numbers/prism-line-numbers';

// 显示语言
import 'prismjs/plugins/show-language/prism-show-language';

// 复制按钮
import 'prismjs/plugins/copy-to-clipboard/prism-copy-to-clipboard';

// 行高亮
import 'prismjs/plugins/line-highlight/prism-line-highlight';
```

### 5.2 Highlight.js

**官网**: https://highlightjs.org/  
**GitHub**: https://github.com/highlightjs/highlight.js  
**许可证**: BSD 3-Clause License  
**版本**: 11.x

#### 5.2.1 简介

Highlight.js 是另一个流行的语法高亮库,特点是自动语言检测。

#### 5.2.2 集成方式

```typescript
import hljs from 'highlight.js';
import 'highlight.js/styles/github-dark.css';

// 自动高亮
hljs.highlightAll();

// 手动高亮
const code = document.querySelector('code');
hljs.highlightElement(code);

// 指定语言
const result = hljs.highlight('console.log("Hello");', {
  language: 'javascript'
});

// 自动检测语言
const result = hljs.highlightAuto('console.log("Hello");');
```

## 6. PDF 查看器

### 6.1 PDF.js

**官网**: https://mozilla.github.io/pdf.js/  
**GitHub**: https://github.com/mozilla/pdf.js  
**许可证**: Apache License 2.0  
**版本**: 3.x

#### 6.1.1 简介

PDF.js 是 Mozilla 开发的 PDF 渲染库,完全用 JavaScript 实现。

#### 6.1.2 核心功能

- 纯 JavaScript 实现
- 支持所有现代浏览器
- 文本选择和搜索
- 注释支持
- 打印功能

#### 6.1.3 集成方式

```typescript
import * as pdfjsLib from 'pdfjs-dist';

// 设置 worker
pdfjsLib.GlobalWorkerOptions.workerSrc = 
  'pdfjs-dist/build/pdf.worker.js';

// 加载 PDF
const loadingTask = pdfjsLib.getDocument('document.pdf');
const pdf = await loadingTask.promise;

// 获取页面
const page = await pdf.getPage(1);

// 渲染到 Canvas
const viewport = page.getViewport({ scale: 1.5 });
const canvas = document.getElementById('pdf-canvas');
const context = canvas.getContext('2d');
canvas.width = viewport.width;
canvas.height = viewport.height;

await page.render({
  canvasContext: context,
  viewport: viewport
}).promise;
```

#### 6.1.4 高级功能

```typescript
// 文本内容
const textContent = await page.getTextContent();
const strings = textContent.items.map(item => item.str);

// 搜索文本
async function searchText(pdf, query) {
  const results = [];
  
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const textContent = await page.getTextContent();
    const text = textContent.items.map(item => item.str).join(' ');
    
    if (text.includes(query)) {
      results.push({ page: i, text });
    }
  }
  
  return results;
}
```

## 7. Markdown 渲染器

### 7.1 Marked.js

**官网**: https://marked.js.org/  
**GitHub**: https://github.com/markedjs/marked  
**许可证**: MIT License  
**版本**: 9.x

#### 7.1.1 简介

Marked 是一个快速的 Markdown 解析器和编译器。

#### 7.1.2 集成方式

```typescript
import { marked } from 'marked';

// 基础使用
const html = marked.parse('# Hello World');

// 配置选项
marked.setOptions({
  gfm: true,
  breaks: true,
  pedantic: false,
  sanitize: false,
  smartLists: true,
  smartypants: false
});

// 自定义渲染器
const renderer = new marked.Renderer();
renderer.heading = (text, level) => {
  const id = text.toLowerCase().replace(/[^\w]+/g, '-');
  return `<h${level} id="${id}">${text}</h${level}>`;
};

marked.use({ renderer });
```

### 7.2 KaTeX

**官网**: https://katex.org/  
**GitHub**: https://github.com/KaTeX/KaTeX  
**许可证**: MIT License  
**版本**: 0.16.x

#### 7.2.1 简介

KaTeX 是一个快速的数学公式排版库。

#### 7.2.2 集成方式

```typescript
import katex from 'katex';
import 'katex/dist/katex.min.css';

// 渲染行内公式
const html = katex.renderToString('c = \\pm\\sqrt{a^2 + b^2}', {
  throwOnError: false,
  displayMode: false
});

// 渲染块级公式
const blockHtml = katex.renderToString('c = \\pm\\sqrt{a^2 + b^2}', {
  throwOnError: false,
  displayMode: true
});

// 自动渲染
import renderMathInElement from 'katex/dist/contrib/auto-render';

renderMathInElement(document.body, {
  delimiters: [
    {left: '$$', right: '$$', display: true},
    {left: '$', right: '$', display: false}
  ]
});
```

### 7.3 Mermaid

**官网**: https://mermaid.js.org/  
**GitHub**: https://github.com/mermaid-js/mermaid  
**许可证**: MIT License  
**版本**: 10.x

#### 7.3.1 简介

Mermaid 用于在 Markdown 中创建图表和可视化。

#### 7.3.2 集成方式

```typescript
import mermaid from 'mermaid';

// 初始化
mermaid.initialize({
  startOnLoad: true,
  theme: 'default',
  securityLevel: 'loose'
});

// 手动渲染
const graphDefinition = `
  graph TD
    A[Start] --> B[Process]
    B --> C[End]
`;

const { svg } = await mermaid.render('graphDiv', graphDefinition);
document.getElementById('output').innerHTML = svg;
```

## 8. 3D 模型查看器

### 8.1 Three.js

**官网**: https://threejs.org/  
**GitHub**: https://github.com/mrdoob/three.js  
**许可证**: MIT License  
**版本**: r150+

#### 8.1.1 简介

Three.js 是一个 3D JavaScript 库,让 WebGL 更易用。

#### 8.1.2 基础集成

```typescript
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';

// 创建场景
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, width/height, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });

renderer.setSize(width, height);
container.appendChild(renderer.domElement);

// 添加控制器
const controls = new OrbitControls(camera, renderer.domElement);

// 加载模型
const loader = new GLTFLoader();
loader.load('model.gltf', (gltf) => {
  scene.add(gltf.scene);
});

// 渲染循环
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();
```

### 8.2 Model Viewer

**官网**: https://modelviewer.dev/  
**GitHub**: https://github.com/google/model-viewer  
**许可证**: Apache License 2.0  
**版本**: 3.x

#### 8.2.1 简介

Model Viewer 是 Google 开发的 Web Component,用于在网页中展示 3D 模型。

#### 8.2.2 集成方式

```html
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<model-viewer
  src="model.gltf"
  alt="3D Model"
  auto-rotate
  camera-controls
  ar
  ar-modes="webxr scene-viewer quick-look"
>
</model-viewer>
```

```typescript
const modelViewer = document.querySelector('model-viewer');

// 控制
modelViewer.cameraOrbit = '45deg 75deg 2m';
modelViewer.fieldOfView = '30deg';

// 事件
modelViewer.addEventListener('load', () => {
  console.log('Model loaded');
});
```

## 9. 文本编辑器/查看器

### 9.1 Monaco Editor

**官网**: https://microsoft.github.io/monaco-editor/  
**GitHub**: https://github.com/microsoft/monaco-editor  
**许可证**: MIT License  
**版本**: 0.44.x

#### 9.1.1 简介

Monaco Editor 是 VS Code 使用的代码编辑器,功能强大。

#### 9.1.2 集成方式

```typescript
import * as monaco from 'monaco-editor';

// 创建编辑器
const editor = monaco.editor.create(container, {
  value: code,
  language: 'javascript',
  theme: 'vs-dark',
  readOnly: true, // 查看器模式
  minimap: { enabled: true },
  scrollBeyondLastLine: false
});

// 设置内容
editor.setValue(newCode);

// 跳转到行
editor.revealLineInCenter(100);

// 搜索
const matches = editor.getModel()?.findMatches(
  'search term',
  true,
  false,
  false,
  null,
  true
);
```

## 10. 依赖管理

### 10.1 Package.json

```json
{
  "dependencies": {
    "video.js": "^8.6.1",
    "plyr": "^3.7.8",
    "howler": "^2.2.4",
    "wavesurfer.js": "^7.3.2",
    "viewerjs": "^1.11.6",
    "photoswipe": "^5.4.2",
    "prismjs": "^1.29.0",
    "highlight.js": "^11.9.0",
    "pdfjs-dist": "^3.11.174",
    "marked": "^9.1.6",
    "katex": "^0.16.9",
    "mermaid": "^10.6.1",
    "three": "^0.158.0",
    "@google/model-viewer": "^3.3.0",
    "monaco-editor": "^0.44.0"
  }
}
```

### 10.2 许可证声明

在应用中包含开源许可证声明：

```typescript
// licenses.ts
export const OPEN_SOURCE_LICENSES = [
  {
    name: 'Video.js',
    version: '8.6.1',
    license: 'Apache-2.0',
    url: 'https://github.com/videojs/video.js',
    licenseText: '...'
  },
  {
    name: 'Howler.js',
    version: '2.2.4',
    license: 'MIT',
    url: 'https://github.com/goldfire/howler.js',
    licenseText: '...'
  },
  // ... 更多
];
```

在 UI 中显示：

```typescript
// 关于页面
function renderLicenses() {
  return `
    <div class="licenses">
      <h2>开源许可证</h2>
      ${OPEN_SOURCE_LICENSES.map(lib => `
        <div class="license-item">
          <h3>${lib.name} ${lib.version}</h3>
          <p>许可证: ${lib.license}</p>
          <a href="${lib.url}" target="_blank">查看源码</a>
          <details>
            <summary>许可证全文</summary>
            <pre>${lib.licenseText}</pre>
          </details>
        </div>
      `).join('')}
    </div>
  `;
}
```

## 11. 打包优化

### 11.1 按需加载

```typescript
// 动态导入减少初始包体积
async function loadVideoPlayer() {
  const { default: videojs } = await import('video.js');
  return videojs;
}

async function loadPDFViewer() {
  const pdfjsLib = await import('pdfjs-dist');
  return pdfjsLib;
}
```

### 11.2 代码分割

```typescript
// webpack.config.js
module.exports = {
  optimization: {
    splitChunks: {
      cacheGroups: {
        videoPlayers: {
          test: /[\\/]node_modules[\\/](video\.js|plyr)/,
          name: 'video-players',
          chunks: 'async'
        },
        audioPlayers: {
          test: /[\\/]node_modules[\\/](howler|wavesurfer)/,
          name: 'audio-players',
          chunks: 'async'
        },
        imageViewers: {
          test: /[\\/]node_modules[\\/](viewerjs|photoswipe)/,
          name: 'image-viewers',
          chunks: 'async'
        }
      }
    }
  }
};
```

### 11.3 CDN 加载

对于大型库可以考虑使用 CDN：

```typescript
// 从 CDN 加载
const script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/video.js@8/dist/video.min.js';
document.head.appendChild(script);

await new Promise((resolve) => {
  script.onload = resolve;
});

// 使用
const player = window.videojs('my-video');
```

## 12. 更新和维护

### 12.1 版本检查

定期检查依赖更新：

```bash
# 检查过时的包
npm outdated

# 更新所有包到最新兼容版本
npm update

# 更新到最新版本（可能有破坏性变更）
npm install package@latest
```

### 12.2 安全审计

```bash
# 检查安全漏洞
npm audit

# 自动修复
npm audit fix
```

### 12.3 依赖更新策略

1. **主要版本更新**：谨慎处理，需要完整测试
2. **次要版本更新**：定期更新，测试核心功能
3. **补丁版本更新**：及时更新，修复 bug
4. **安全更新**：立即更新，无论版本

## 13. 总结

通过集成成熟的开源工具，Chips Viewer 能够：

- **快速开发**：不需要从零实现复杂功能
- **保证质量**：使用经过验证的稳定方案
- **降低维护成本**：社区持续维护和更新
- **提升用户体验**：提供专业级的查看功能

同时需要注意：

- **许可证合规**：遵守所有开源协议
- **版本管理**：及时更新和修复漏洞
- **性能优化**：合理打包和按需加载
- **文档维护**：记录所有使用的开源工具

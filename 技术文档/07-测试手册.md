# 测试手册

## 1. 测试策略概述

Chips Viewer 采用多层次的测试策略,确保软件质量和稳定性。

### 1.1 测试金字塔

```
              /\
             /  \
            / E2E\           端到端测试 (10%)
           /      \          - 用户场景测试
          /--------\         - 跨平台测试
         /          \
        /   集成测试  \       集成测试 (30%)
       /              \      - API 集成
      /----------------\     - 模块协作
     /                  \
    /      单元测试        \  单元测试 (60%)
   /                      \ - 函数测试
  /--------------------------\ - 类测试
```

### 1.2 测试覆盖率目标

- **单元测试覆盖率**: ≥ 80%
- **集成测试覆盖率**: ≥ 60%
- **E2E 测试覆盖率**: 核心场景 100%
- **总体代码覆盖率**: ≥ 75%

## 2. 测试框架和工具

### 2.1 测试框架

#### 2.1.1 单元测试和集成测试

**Jest** (推荐)

```json
{
  "dependencies": {
    "jest": "^29.0.0",
    "@types/jest": "^29.0.0",
    "ts-jest": "^29.0.0"
  }
}
```

**配置文件 jest.config.js**:

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: [
    '**/__tests__/**/*.ts',
    '**/?(*.)+(spec|test).ts'
  ],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/index.ts'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts']
};
```

#### 2.1.2 E2E 测试

**Playwright** (推荐用于跨平台测试)

```json
{
  "devDependencies": {
    "@playwright/test": "^1.40.0"
  }
}
```

**配置文件 playwright.config.ts**:

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    // 移动端测试
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
});
```

### 2.2 测试工具

- **@testing-library/react**: React 组件测试
- **@testing-library/user-event**: 用户交互模拟
- **msw**: API Mock
- **nock**: HTTP Mock
- **jest-mock-extended**: 高级 Mock
- **faker-js**: 测试数据生成

## 3. 单元测试

### 3.1 渲染引擎测试

#### 3.1.1 卡片渲染器测试

```typescript
// tests/renderer/CardRenderer.test.ts
import { CardRenderer } from '@/renderer/CardRenderer';
import { RichTextCard } from '@/types/cards';

describe('CardRenderer', () => {
  let renderer: CardRenderer;
  let container: HTMLElement;
  
  beforeEach(() => {
    renderer = new CardRenderer();
    container = document.createElement('div');
  });
  
  afterEach(() => {
    container.remove();
  });
  
  describe('render', () => {
    it('应该正确渲染富文本卡片', async () => {
      const card: RichTextCard = {
        id: 'test-card-1',
        type: 'richtext',
        version: '1.0.0',
        metadata: {},
        content: {
          blocks: [
            { type: 'paragraph', text: 'Hello World' }
          ]
        }
      };
      
      const result = await renderer.render(card, container);
      
      expect(result.element).toBeInTheDocument();
      expect(result.element.textContent).toContain('Hello World');
      expect(container.querySelector('.card-richtext')).toBeTruthy();
    });
    
    it('应该正确应用主题', async () => {
      const card: RichTextCard = createMockCard();
      const theme = createMockTheme();
      
      await renderer.render(card, container, { theme });
      
      const element = container.querySelector('.card-richtext') as HTMLElement;
      expect(element.style.backgroundColor).toBe(theme.colors.surface);
    });
    
    it('应该处理嵌套卡片', async () => {
      const compositeCard = createMockCompositeCard();
      
      const result = await renderer.render(compositeCard, container);
      
      expect(container.querySelectorAll('.card-child').length).toBe(2);
    });
  });
  
  describe('update', () => {
    it('应该更新卡片内容', async () => {
      const card = createMockCard();
      await renderer.render(card, container);
      
      const updates = { content: { blocks: [{ type: 'paragraph', text: 'Updated' }] } };
      renderer.update(card.id, updates);
      
      expect(container.textContent).toContain('Updated');
    });
  });
  
  describe('dispose', () => {
    it('应该清理渲染资源', async () => {
      const card = createMockCard();
      const result = await renderer.render(card, container);
      
      renderer.dispose(card.id);
      
      expect(container.innerHTML).toBe('');
    });
  });
});
```

#### 3.1.2 主题应用器测试

```typescript
// tests/renderer/ThemeApplier.test.ts
import { ThemeApplier } from '@/renderer/ThemeApplier';
import { Theme } from '@/types/theme';

describe('ThemeApplier', () => {
  let applier: ThemeApplier;
  let element: HTMLElement;
  
  beforeEach(() => {
    applier = new ThemeApplier();
    element = document.createElement('div');
  });
  
  it('应该设置 CSS 变量', () => {
    const theme: Theme = createMockTheme();
    
    applier.apply(theme, element);
    
    expect(element.style.getPropertyValue('--color-primary')).toBe(theme.colors.primary);
    expect(element.style.getPropertyValue('--font-family')).toBe(theme.typography.fontFamily);
  });
  
  it('应该添加主题类名', () => {
    const theme = createMockTheme();
    
    applier.apply(theme, element);
    
    expect(element.classList.contains(`theme-${theme.id}`)).toBe(true);
  });
  
  it('应该移除主题', () => {
    const theme = createMockTheme();
    applier.apply(theme, element);
    
    applier.remove(element);
    
    expect(element.className).toBe('');
  });
});
```

#### 3.1.3 布局引擎测试

```typescript
// tests/renderer/LayoutEngine.test.ts
import { GridLayoutEngine } from '@/renderer/GridLayoutEngine';

describe('GridLayoutEngine', () => {
  let engine: GridLayoutEngine;
  
  beforeEach(() => {
    engine = new GridLayoutEngine();
  });
  
  it('应该计算网格布局', () => {
    const items = createMockLayoutItems(6);
    const constraints = {
      containerWidth: 1200,
      columns: 3,
      gap: 16,
      padding: 16
    };
    
    const layout = engine.calculate(items, constraints);
    
    expect(layout.items.length).toBe(6);
    expect(layout.items[0].x).toBe(16);
    expect(layout.items[1].x).toBeGreaterThan(layout.items[0].x);
  });
  
  it('应该处理响应式布局', () => {
    const items = createMockLayoutItems(6);
    
    // 桌面端
    const desktopLayout = engine.calculate(items, {
      containerWidth: 1200,
      columns: 4
    });
    expect(desktopLayout.items[0].width).toBeCloseTo(285);
    
    // 移动端
    const mobileLayout = engine.calculate(items, {
      containerWidth: 375,
      columns: 1
    });
    expect(mobileLayout.items[0].width).toBeCloseTo(343);
  });
});
```

### 3.2 插件系统测试

#### 3.2.1 插件管理器测试

```typescript
// tests/plugin/PluginManager.test.ts
import { PluginManager } from '@/plugin/PluginManager';
import { IViewerToolPlugin } from '@/types/plugin';

describe('PluginManager', () => {
  let manager: PluginManager;
  
  beforeEach(() => {
    manager = new PluginManager();
  });
  
  describe('install', () => {
    it('应该安装插件', async () => {
      const pluginPath = '/path/to/test-plugin';
      
      await manager.install(pluginPath);
      
      const plugin = manager.getPlugin('com.test.plugin');
      expect(plugin).toBeDefined();
    });
    
    it('应该验证插件清单', async () => {
      const invalidPluginPath = '/path/to/invalid-plugin';
      
      await expect(manager.install(invalidPluginPath))
        .rejects.toThrow('Invalid plugin manifest');
    });
    
    it('应该检查依赖', async () => {
      const pluginPath = '/path/to/plugin-with-deps';
      
      await manager.install(pluginPath);
      
      // 验证依赖已加载
      expect(manager.getPlugin('com.test.dependency')).toBeDefined();
    });
  });
  
  describe('uninstall', () => {
    it('应该卸载插件', async () => {
      await manager.install('/path/to/test-plugin');
      
      await manager.uninstall('com.test.plugin');
      
      expect(manager.getPlugin('com.test.plugin')).toBeNull();
    });
    
    it('应该调用插件的 destroy 方法', async () => {
      const plugin = createMockPlugin();
      const destroySpy = jest.spyOn(plugin, 'destroy');
      
      await manager.install('/path/to/test-plugin');
      await manager.uninstall('com.test.plugin');
      
      expect(destroySpy).toHaveBeenCalled();
    });
  });
  
  describe('getPluginsForType', () => {
    it('应该返回支持指定类型的所有插件', async () => {
      await manager.install('/path/to/video-plugin');
      await manager.install('/path/to/another-video-plugin');
      
      const plugins = manager.getPluginsForType('video/mp4');
      
      expect(plugins.length).toBe(2);
    });
  });
  
  describe('setDefaultPlugin', () => {
    it('应该设置默认插件', async () => {
      await manager.install('/path/to/video-plugin');
      
      manager.setDefaultPlugin('video/mp4', 'com.test.video-plugin');
      
      const defaultPlugin = manager.getDefaultPlugin('video/mp4');
      expect(defaultPlugin?.manifest.id).toBe('com.test.video-plugin');
    });
  });
});
```

#### 3.2.2 插件调度器测试

```typescript
// tests/plugin/PluginDispatcher.test.ts
import { PluginDispatcher } from '@/plugin/PluginDispatcher';

describe('PluginDispatcher', () => {
  let dispatcher: PluginDispatcher;
  let mockManager: jest.Mocked<PluginManager>;
  
  beforeEach(() => {
    mockManager = createMockPluginManager();
    dispatcher = new PluginDispatcher(mockManager);
  });
  
  it('应该调度到正确的插件', async () => {
    const file = createMockFile('video.mp4', 'video/mp4');
    const container = document.createElement('div');
    
    const result = await dispatcher.dispatch(file, container);
    
    expect(result.element).toBeInTheDocument();
    expect(mockManager.getDefaultPlugin).toHaveBeenCalledWith('video/mp4');
  });
  
  it('应该使用首选插件', async () => {
    const file = createMockFile('video.mp4', 'video/mp4');
    const container = document.createElement('div');
    
    await dispatcher.dispatch(file, container, {
      preferredPluginId: 'com.custom.video-player'
    });
    
    expect(mockManager.getPlugin).toHaveBeenCalledWith('com.custom.video-player');
  });
  
  it('应该在插件失败时回退', async () => {
    const file = createMockFile('unknown.xyz', 'application/octet-stream');
    const container = document.createElement('div');
    
    const result = await dispatcher.dispatch(file, container);
    
    expect(container.querySelector('.viewer-error')).toBeTruthy();
  });
});
```

### 3.3 文件解析测试

```typescript
// tests/core/CardParser.test.ts
import { CardParser } from '@/core/CardParser';

describe('CardParser', () => {
  let parser: CardParser;
  
  beforeEach(() => {
    parser = new CardParser();
  });
  
  it('应该解析有效的卡片文件', () => {
    const data = createMockCardData();
    
    const card = parser.parse(data);
    
    expect(card.id).toBeDefined();
    expect(card.type).toBe('richtext');
    expect(card.version).toBe('1.0.0');
  });
  
  it('应该验证卡片数据', () => {
    const invalidData = createInvalidCardData();
    
    expect(() => parser.parse(invalidData))
      .toThrow('Invalid card data');
  });
  
  it('应该提取元数据', () => {
    const data = createMockCardData();
    
    const metadata = parser.getMetadata(data);
    
    expect(metadata.type).toBe('richtext');
    expect(metadata.size).toBeGreaterThan(0);
  });
});
```

## 4. 集成测试

### 4.1 渲染流程集成测试

```typescript
// tests/integration/rendering.test.ts
import { ViewerApp } from '@/ViewerApp';

describe('渲染流程集成测试', () => {
  let app: ViewerApp;
  let container: HTMLElement;
  
  beforeEach(() => {
    app = new ViewerApp();
    container = document.createElement('div');
    document.body.appendChild(container);
  });
  
  afterEach(() => {
    container.remove();
  });
  
  it('应该完整渲染卡片文件', async () => {
    const cardPath = '/test-data/sample.card';
    
    await app.openCard(cardPath, container);
    
    expect(container.querySelector('.card-richtext')).toBeTruthy();
    expect(container.textContent).toBeTruthy();
  });
  
  it('应该应用主题到渲染结果', async () => {
    const cardPath = '/test-data/sample.card';
    await app.openCard(cardPath, container);
    
    app.setTheme('dark');
    
    const element = container.querySelector('.card-richtext') as HTMLElement;
    expect(element.classList.contains('theme-dark')).toBe(true);
  });
  
  it('应该处理复合卡片', async () => {
    const compositePath = '/test-data/composite.card';
    
    await app.openCard(compositePath, container);
    
    expect(container.querySelectorAll('.card-child').length).toBeGreaterThan(1);
  });
});
```

### 4.2 插件加载集成测试

```typescript
// tests/integration/plugin-loading.test.ts
import { ViewerApp } from '@/ViewerApp';

describe('插件加载集成测试', () => {
  let app: ViewerApp;
  
  beforeEach(() => {
    app = new ViewerApp();
  });
  
  it('应该加载并使用插件', async () => {
    await app.pluginManager.install('/plugins/video-player');
    
    const plugin = app.pluginManager.getPlugin('com.chips.video-player');
    expect(plugin).toBeDefined();
    
    // 测试插件功能
    const file = createMockFile('video.mp4', 'video/mp4');
    const container = document.createElement('div');
    
    const result = await plugin!.render(file, container);
    expect(result.element).toBeTruthy();
  });
  
  it('应该处理插件依赖', async () => {
    await app.pluginManager.install('/plugins/advanced-video-player');
    
    // 验证依赖插件也被加载
    const dependency = app.pluginManager.getPlugin('com.chips.video-codec');
    expect(dependency).toBeDefined();
  });
});
```

### 4.3 主题切换集成测试

```typescript
// tests/integration/theme-switching.test.ts
import { ViewerApp } from '@/ViewerApp';

describe('主题切换集成测试', () => {
  let app: ViewerApp;
  let container: HTMLElement;
  
  beforeEach(async () => {
    app = new ViewerApp();
    container = document.createElement('div');
    document.body.appendChild(container);
    
    await app.openCard('/test-data/sample.card', container);
  });
  
  afterEach(() => {
    container.remove();
  });
  
  it('应该切换主题', () => {
    app.setTheme('dark');
    
    const element = container.querySelector('.card-richtext') as HTMLElement;
    expect(element.classList.contains('theme-dark')).toBe(true);
    expect(element.style.getPropertyValue('--color-background')).toBe('#121212');
  });
  
  it('应该支持自定义主题', () => {
    const customTheme = createCustomTheme();
    
    app.loadTheme(customTheme);
    app.setTheme(customTheme.id);
    
    const element = container.querySelector('.card-richtext') as HTMLElement;
    expect(element.classList.contains(`theme-${customTheme.id}`)).toBe(true);
  });
});
```

## 5. 端到端测试

### 5.1 用户场景测试

#### 5.1.1 打开和查看卡片

```typescript
// e2e/view-card.spec.ts
import { test, expect } from '@playwright/test';

test.describe('查看卡片', () => {
  test('应该打开并显示卡片', async ({ page }) => {
    await page.goto('http://localhost:3000');
    
    // 打开文件对话框
    await page.click('[data-testid="open-button"]');
    
    // 选择文件
    await page.setInputFiles('input[type="file"]', './test-data/sample.card');
    
    // 等待卡片加载
    await page.waitForSelector('.card-richtext');
    
    // 验证内容显示
    await expect(page.locator('.card-richtext')).toBeVisible();
    await expect(page.locator('.card-richtext')).toContainText('Hello');
  });
  
  test('应该导航卡片历史', async ({ page }) => {
    await page.goto('http://localhost:3000');
    
    // 打开第一个卡片
    await openCard(page, './test-data/card1.card');
    await expect(page.locator('.card-richtext')).toContainText('Card 1');
    
    // 打开第二个卡片
    await openCard(page, './test-data/card2.card');
    await expect(page.locator('.card-richtext')).toContainText('Card 2');
    
    // 点击后退
    await page.click('[data-testid="back-button"]');
    await expect(page.locator('.card-richtext')).toContainText('Card 1');
    
    // 点击前进
    await page.click('[data-testid="forward-button"]');
    await expect(page.locator('.card-richtext')).toContainText('Card 2');
  });
});
```

#### 5.1.2 插件使用

```typescript
// e2e/plugin-usage.spec.ts
import { test, expect } from '@playwright/test';

test.describe('插件使用', () => {
  test('应该使用插件查看视频', async ({ page }) => {
    await page.goto('http://localhost:3000');
    
    // 打开视频文件
    await openCard(page, './test-data/video.mp4');
    
    // 验证视频播放器加载
    await page.waitForSelector('video');
    await expect(page.locator('video')).toBeVisible();
    
    // 测试播放控制
    await page.click('[data-testid="play-button"]');
    await page.waitForTimeout(1000);
    
    const isPaused = await page.locator('video').evaluate((el: HTMLVideoElement) => el.paused);
    expect(isPaused).toBe(false);
  });
  
  test('应该切换插件', async ({ page }) => {
    await page.goto('http://localhost:3000');
    await openCard(page, './test-data/image.jpg');
    
    // 打开插件选择器
    await page.click('[data-testid="plugin-selector"]');
    
    // 选择不同的插件
    await page.click('[data-plugin-id="advanced-image-viewer"]');
    
    // 验证新插件加载
    await expect(page.locator('.advanced-image-viewer')).toBeVisible();
  });
});
```

#### 5.1.3 主题切换

```typescript
// e2e/theme-switching.spec.ts
import { test, expect } from '@playwright/test';

test.describe('主题切换', () => {
  test('应该切换到深色主题', async ({ page }) => {
    await page.goto('http://localhost:3000');
    await openCard(page, './test-data/sample.card');
    
    // 打开设置
    await page.click('[data-testid="settings-button"]');
    
    // 选择深色主题
    await page.click('[data-theme-id="dark"]');
    
    // 验证主题应用
    const bgColor = await page.locator('.card-richtext').evaluate(
      (el: HTMLElement) => getComputedStyle(el).backgroundColor
    );
    
    expect(bgColor).toBe('rgb(18, 18, 18)'); // #121212
  });
});
```

### 5.2 跨平台测试

```typescript
// e2e/cross-platform.spec.ts
import { test, expect } from '@playwright/test';

test.describe('跨平台测试', () => {
  test('桌面端 - Chrome', async ({ page }) => {
    test.use({ ...devices['Desktop Chrome'] });
    
    await page.goto('http://localhost:3000');
    await openCard(page, './test-data/sample.card');
    
    await expect(page.locator('.card-richtext')).toBeVisible();
  });
  
  test('移动端 - iPhone', async ({ page }) => {
    test.use({ ...devices['iPhone 12'] });
    
    await page.goto('http://localhost:3000');
    await openCard(page, './test-data/sample.card');
    
    // 验证响应式布局
    const width = await page.locator('.card-richtext').evaluate(
      (el: HTMLElement) => el.offsetWidth
    );
    expect(width).toBeLessThan(400);
  });
  
  test('平板端 - iPad', async ({ page }) => {
    test.use({ ...devices['iPad Pro'] });
    
    await page.goto('http://localhost:3000');
    await openCard(page, './test-data/sample.card');
    
    await expect(page.locator('.card-richtext')).toBeVisible();
  });
});
```

## 6. 性能测试

### 6.1 渲染性能测试

```typescript
// tests/performance/rendering.perf.test.ts
import { performance } from 'perf_hooks';

describe('渲染性能测试', () => {
  it('应该在100ms内渲染简单卡片', async () => {
    const renderer = new CardRenderer();
    const card = createSimpleCard();
    const container = document.createElement('div');
    
    const start = performance.now();
    await renderer.render(card, container);
    const end = performance.now();
    
    expect(end - start).toBeLessThan(100);
  });
  
  it('应该在500ms内渲染复杂卡片', async () => {
    const renderer = new CardRenderer();
    const card = createComplexCard(); // 包含多个子卡片
    const container = document.createElement('div');
    
    const start = performance.now();
    await renderer.render(card, container);
    const end = performance.now();
    
    expect(end - start).toBeLessThan(500);
  });
  
  it('应该在2秒内渲染100个卡片', async () => {
    const renderer = new CardRenderer();
    const cards = Array.from({ length: 100 }, () => createSimpleCard());
    const container = document.createElement('div');
    
    const start = performance.now();
    for (const card of cards) {
      await renderer.render(card, container);
    }
    const end = performance.now();
    
    expect(end - start).toBeLessThan(2000);
  });
});
```

### 6.2 内存测试

```typescript
// tests/performance/memory.perf.test.ts
describe('内存测试', () => {
  it('应该在渲染后释放内存', async () => {
    const renderer = new CardRenderer();
    const card = createLargeCard();
    const container = document.createElement('div');
    
    const before = (performance as any).memory?.usedJSHeapSize;
    
    const result = await renderer.render(card, container);
    result.dispose();
    
    // 强制垃圾回收
    if (global.gc) {
      global.gc();
    }
    
    const after = (performance as any).memory?.usedJSHeapSize;
    
    // 内存增长应该小于1MB
    expect(after - before).toBeLessThan(1024 * 1024);
  });
  
  it('应该处理大量卡片而不内存泄漏', async () => {
    const renderer = new CardRenderer();
    const container = document.createElement('div');
    
    for (let i = 0; i < 1000; i++) {
      const card = createSimpleCard();
      const result = await renderer.render(card, container);
      result.dispose();
    }
    
    if (global.gc) {
      global.gc();
    }
    
    const heapUsed = (performance as any).memory?.usedJSHeapSize;
    expect(heapUsed).toBeLessThan(50 * 1024 * 1024); // 小于50MB
  });
});
```

### 6.3 加载性能测试

```typescript
// tests/performance/loading.perf.test.ts
describe('加载性能测试', () => {
  it('应该在50ms内加载小文件', async () => {
    const parser = new CardParser();
    const fileData = await readTestFile('small.card'); // <100KB
    
    const start = performance.now();
    parser.parse(fileData);
    const end = performance.now();
    
    expect(end - start).toBeLessThan(50);
  });
  
  it('应该在200ms内加载中等文件', async () => {
    const parser = new CardParser();
    const fileData = await readTestFile('medium.card'); // <1MB
    
    const start = performance.now();
    parser.parse(fileData);
    const end = performance.now();
    
    expect(end - start).toBeLessThan(200);
  });
});
```

## 7. 安全测试

### 7.1 输入验证测试

```typescript
// tests/security/input-validation.test.ts
describe('输入验证测试', () => {
  it('应该拒绝无效的卡片数据', () => {
    const parser = new CardParser();
    const maliciousData = createMaliciousCardData();
    
    expect(() => parser.parse(maliciousData))
      .toThrow('Invalid card data');
  });
  
  it('应该防止 XSS 攻击', async () => {
    const renderer = new CardRenderer();
    const card = {
      id: 'test',
      type: 'richtext',
      version: '1.0.0',
      metadata: {},
      content: {
        blocks: [
          { type: 'paragraph', text: '<script>alert("XSS")</script>' }
        ]
      }
    };
    
    const container = document.createElement('div');
    await renderer.render(card, container);
    
    // 验证脚本没有执行
    expect(container.querySelector('script')).toBeNull();
    expect(container.textContent).toContain('<script>');
  });
});
```

### 7.2 插件沙箱测试

```typescript
// tests/security/plugin-sandbox.test.ts
describe('插件沙箱测试', () => {
  it('应该限制插件的文件系统访问', async () => {
    const sandbox = new PluginSandbox();
    const plugin = await sandbox.loadInSandbox('/path/to/plugin', manifest);
    
    // 尝试访问受限路径
    await expect(plugin.readFile('/etc/passwd'))
      .rejects.toThrow('Access denied');
  });
  
  it('应该限制插件的网络访问', async () => {
    const sandbox = new PluginSandbox();
    const plugin = await sandbox.loadInSandbox('/path/to/plugin', {
      ...manifest,
      permissions: [] // 没有网络权限
    });
    
    await expect(plugin.fetch('https://example.com'))
      .rejects.toThrow('Network access denied');
  });
});
```

## 8. CI/CD 集成

### 8.1 GitHub Actions 配置

```yaml
# .github/workflows/test.yml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [18, 20]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Run integration tests
        run: npm run test:integration
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
  
  e2e:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps
      
      - name: Run E2E tests
        run: npm run test:e2e
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
```

### 8.2 测试脚本

```json
{
  "scripts": {
    "test": "npm run test:unit && npm run test:integration",
    "test:unit": "jest --testPathPattern=tests/.*\\.test\\.ts$",
    "test:integration": "jest --testPathPattern=tests/integration/",
    "test:e2e": "playwright test",
    "test:perf": "jest --testPathPattern=tests/performance/",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --maxWorkers=2"
  }
}
```

## 9. 测试最佳实践

### 9.1 测试命名规范

```typescript
// ✅ 好的命名
describe('CardRenderer', () => {
  describe('render', () => {
    it('应该正确渲染富文本卡片', () => {});
    it('应该在缺少必需字段时抛出错误', () => {});
  });
});

// ❌ 不好的命名
describe('test1', () => {
  it('works', () => {});
});
```

### 9.2 测试隔离

```typescript
// ✅ 每个测试独立
describe('CardRenderer', () => {
  let renderer: CardRenderer;
  
  beforeEach(() => {
    renderer = new CardRenderer(); // 每个测试创建新实例
  });
  
  it('test 1', () => {});
  it('test 2', () => {});
});

// ❌ 测试之间共享状态
describe('CardRenderer', () => {
  const renderer = new CardRenderer(); // 共享实例可能导致测试相互影响
  
  it('test 1', () => {});
  it('test 2', () => {});
});
```

### 9.3 使用测试工具函数

```typescript
// tests/utils/test-helpers.ts
export function createMockCard(overrides?: Partial<Card>): Card {
  return {
    id: 'test-card',
    type: 'richtext',
    version: '1.0.0',
    metadata: {},
    content: { blocks: [] },
    ...overrides
  };
}

export function createMockTheme(overrides?: Partial<Theme>): Theme {
  return {
    id: 'test-theme',
    name: 'Test Theme',
    version: '1.0.0',
    colors: {
      primary: '#1976d2',
      // ...
    },
    // ...
    ...overrides
  };
}

export async function waitForRender(element: HTMLElement, timeout = 1000): Promise<void> {
  const start = Date.now();
  while (!element.textContent && Date.now() - start < timeout) {
    await new Promise(resolve => setTimeout(resolve, 10));
  }
}
```

## 10. 测试报告

### 10.1 覆盖率报告

测试运行后生成覆盖率报告：

```bash
npm run test:coverage
```

报告位置：
- HTML 报告：`coverage/lcov-report/index.html`
- 文本报告：终端输出
- LCOV 文件：`coverage/lcov.info`

### 10.2 性能报告

性能测试结果应记录在：

```
performance-reports/
├── rendering-performance.md
├── memory-usage.md
└── loading-times.md
```

### 10.3 E2E 测试报告

Playwright 测试报告：

```bash
npx playwright show-report
```

## 11. 持续改进

### 11.1 定期审查

- **每周**：审查测试失败和不稳定的测试
- **每月**：审查测试覆盖率，识别未覆盖的代码
- **每季度**：更新测试策略，引入新的测试工具

### 11.2 测试维护

- 删除过时的测试
- 重构重复的测试代码
- 更新测试以匹配新功能
- 优化慢速测试

### 11.3 文档更新

- 记录新的测试模式
- 更新测试工具文档
- 分享测试最佳实践

## 总结

Chips Viewer 的测试手册提供了完整的测试策略和实践指南。通过多层次的测试（单元测试、集成测试、E2E 测试、性能测试、安全测试），确保产品质量和稳定性。所有测试都集成到 CI/CD 流程中，实现自动化质量保证。

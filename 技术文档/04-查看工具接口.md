# 查看工具接口

## 1. 接口概述

查看工具接口定义了各种文件查看工具（视频播放器、音乐播放器、图片查看器等）与 Chips Viewer 之间的标准交互协议。通过统一的接口，不同的查看工具可以无缝集成到查看器中。

### 1.1 设计目标

1. **统一标准**：所有查看工具遵循相同的接口规范
2. **易于实现**：接口简洁明了，易于第三方开发者实现
3. **功能完整**：覆盖常见的查看和控制需求
4. **扩展灵活**：支持工具特有的高级功能
5. **向后兼容**：新版本接口兼容旧版本

### 1.2 接口分类

- **核心接口**：所有查看工具必须实现
- **可选接口**：根据工具类型选择实现
- **扩展接口**：工具特有的高级功能

## 2. 核心接口

### 2.1 基础查看工具接口

所有查看工具必须实现的基础接口：

```typescript
/**
 * 基础查看工具接口
 */
interface IViewerTool {
  /**
   * 工具元数据
   */
  readonly metadata: ViewerToolMetadata;
  
  /**
   * 初始化工具
   * @param context 工具上下文
   */
  init(context: ToolContext): Promise<void>;
  
  /**
   * 销毁工具
   */
  destroy(): Promise<void>;
  
  /**
   * 检查是否支持指定文件
   * @param file 文件信息
   * @returns 是否支持
   */
  supports(file: FileInfo): boolean;
  
  /**
   * 加载文件
   * @param file 文件信息
   * @param container 容器元素
   * @param options 加载选项
   * @returns 加载结果
   */
  load(
    file: FileInfo,
    container: HTMLElement,
    options?: LoadOptions
  ): Promise<LoadResult>;
  
  /**
   * 卸载当前文件
   */
  unload(): Promise<void>;
  
  /**
   * 获取工具状态
   */
  getState(): ToolState;
  
  /**
   * 监听事件
   */
  on(event: string, handler: EventHandler): void;
  
  /**
   * 取消监听
   */
  off(event: string, handler: EventHandler): void;
}

/**
 * 工具元数据
 */
interface ViewerToolMetadata {
  id: string;
  name: string;
  version: string;
  description?: string;
  author?: string;
  
  /**
   * 支持的 MIME 类型
   */
  supportedTypes: string[];
  
  /**
   * 支持的文件扩展名
   */
  supportedExtensions: string[];
  
  /**
   * 工具能力
   */
  capabilities: ToolCapabilities;
}

/**
 * 工具能力
 */
interface ToolCapabilities {
  /**
   * 是否支持播放控制（视频/音频）
   */
  playback?: boolean;
  
  /**
   * 是否支持缩放
   */
  zoom?: boolean;
  
  /**
   * 是否支持旋转
   */
  rotation?: boolean;
  
  /**
   * 是否支持全屏
   */
  fullscreen?: boolean;
  
  /**
   * 是否支持搜索
   */
  search?: boolean;
  
  /**
   * 自定义能力
   */
  [key: string]: any;
}

/**
 * 工具上下文
 */
interface ToolContext {
  /**
   * 查看器 API
   */
  viewer: ViewerAPI;
  
  /**
   * 工具配置
   */
  settings: ToolSettings;
  
  /**
   * 工具存储
   */
  storage: ToolStorage;
  
  /**
   * 日志记录器
   */
  logger: Logger;
}

/**
 * 加载选项
 */
interface LoadOptions {
  /**
   * 主题
   */
  theme?: Theme;
  
  /**
   * 自动开始（播放/展示）
   */
  autoStart?: boolean;
  
  /**
   * 只读模式
   */
  readonly?: boolean;
  
  /**
   * 自定义选项
   */
  [key: string]: any;
}

/**
 * 加载结果
 */
interface LoadResult {
  /**
   * 是否成功
   */
  success: boolean;
  
  /**
   * 渲染的元素
   */
  element?: HTMLElement;
  
  /**
   * 控制器
   */
  controller?: ToolController;
  
  /**
   * 错误信息
   */
  error?: Error;
}

/**
 * 工具状态
 */
interface ToolState {
  /**
   * 是否已加载
   */
  loaded: boolean;
  
  /**
   * 是否正在播放/活动
   */
  active: boolean;
  
  /**
   * 当前文件
   */
  currentFile?: FileInfo;
  
  /**
   * 自定义状态
   */
  [key: string]: any;
}

/**
 * 工具控制器
 */
interface ToolController {
  /**
   * 执行命令
   */
  execute(command: string, ...args: any[]): Promise<any>;
  
  /**
   * 获取当前值
   */
  get(property: string): any;
  
  /**
   * 设置值
   */
  set(property: string, value: any): void;
}
```

## 3. 播放器接口

### 3.1 媒体播放器接口

适用于视频和音频播放器：

```typescript
/**
 * 媒体播放器接口
 */
interface IMediaPlayer extends IViewerTool {
  /**
   * 播放
   */
  play(): Promise<void>;
  
  /**
   * 暂停
   */
  pause(): Promise<void>;
  
  /**
   * 停止
   */
  stop(): Promise<void>;
  
  /**
   * 跳转到指定位置
   * @param time 时间（秒）
   */
  seek(time: number): Promise<void>;
  
  /**
   * 设置音量
   * @param volume 音量（0-1）
   */
  setVolume(volume: number): void;
  
  /**
   * 获取音量
   */
  getVolume(): number;
  
  /**
   * 静音/取消静音
   */
  mute(muted: boolean): void;
  
  /**
   * 是否静音
   */
  isMuted(): boolean;
  
  /**
   * 设置播放速度
   * @param rate 播放速度（0.25 - 2.0）
   */
  setPlaybackRate(rate: number): void;
  
  /**
   * 获取播放速度
   */
  getPlaybackRate(): number;
  
  /**
   * 获取当前播放时间
   */
  getCurrentTime(): number;
  
  /**
   * 获取总时长
   */
  getDuration(): number;
  
  /**
   * 是否正在播放
   */
  isPlaying(): boolean;
  
  /**
   * 是否已结束
   */
  isEnded(): boolean;
  
  /**
   * 获取缓冲进度
   * @returns 缓冲百分比（0-100）
   */
  getBuffered(): number;
}

/**
 * 媒体播放器事件
 */
interface MediaPlayerEvents {
  'play': () => void;
  'pause': () => void;
  'stop': () => void;
  'ended': () => void;
  'timeupdate': (time: number) => void;
  'durationchange': (duration: number) => void;
  'volumechange': (volume: number) => void;
  'ratechange': (rate: number) => void;
  'progress': (buffered: number) => void;
  'error': (error: Error) => void;
}
```

### 3.2 视频播放器接口

视频播放器的特有功能：

```typescript
/**
 * 视频播放器接口
 */
interface IVideoPlayer extends IMediaPlayer {
  /**
   * 获取视频尺寸
   */
  getVideoSize(): { width: number; height: number };
  
  /**
   * 切换全屏
   */
  toggleFullscreen(): Promise<void>;
  
  /**
   * 是否全屏
   */
  isFullscreen(): boolean;
  
  /**
   * 加载字幕
   * @param subtitle 字幕文件或 URL
   */
  loadSubtitle(subtitle: string | File): Promise<void>;
  
  /**
   * 显示/隐藏字幕
   */
  showSubtitle(show: boolean): void;
  
  /**
   * 设置字幕轨道
   * @param trackIndex 轨道索引
   */
  setSubtitleTrack(trackIndex: number): void;
  
  /**
   * 获取所有字幕轨道
   */
  getSubtitleTracks(): SubtitleTrack[];
  
  /**
   * 设置音频轨道
   * @param trackIndex 轨道索引
   */
  setAudioTrack(trackIndex: number): void;
  
  /**
   * 获取所有音频轨道
   */
  getAudioTracks(): AudioTrack[];
  
  /**
   * 截图
   * @returns 图片数据 URL
   */
  takeScreenshot(): Promise<string>;
  
  /**
   * 画中画
   */
  togglePictureInPicture(): Promise<void>;
  
  /**
   * 是否画中画模式
   */
  isPictureInPicture(): boolean;
}

interface SubtitleTrack {
  index: number;
  label: string;
  language: string;
  kind: 'subtitles' | 'captions' | 'descriptions';
}

interface AudioTrack {
  index: number;
  label: string;
  language: string;
}

/**
 * 视频播放器事件
 */
interface VideoPlayerEvents extends MediaPlayerEvents {
  'fullscreenchange': (fullscreen: boolean) => void;
  'subtitlechange': (trackIndex: number) => void;
  'audiotrackchange': (trackIndex: number) => void;
  'pictureinpicturechange': (pip: boolean) => void;
}
```

### 3.3 音乐播放器接口

音乐播放器的特有功能：

```typescript
/**
 * 音乐播放器接口
 */
interface IAudioPlayer extends IMediaPlayer {
  /**
   * 加载播放列表
   */
  loadPlaylist(files: FileInfo[]): Promise<void>;
  
  /**
   * 播放下一首
   */
  next(): Promise<void>;
  
  /**
   * 播放上一首
   */
  previous(): Promise<void>;
  
  /**
   * 跳转到指定曲目
   */
  goto(index: number): Promise<void>;
  
  /**
   * 设置循环模式
   * @param mode 'none' | 'one' | 'all' | 'shuffle'
   */
  setLoopMode(mode: LoopMode): void;
  
  /**
   * 获取循环模式
   */
  getLoopMode(): LoopMode;
  
  /**
   * 获取当前曲目索引
   */
  getCurrentIndex(): number;
  
  /**
   * 获取播放列表
   */
  getPlaylist(): FileInfo[];
  
  /**
   * 获取音频元数据
   */
  getMetadata(): AudioMetadata;
  
  /**
   * 设置均衡器
   * @param bands 频段增益数组
   */
  setEqualizer(bands: number[]): void;
  
  /**
   * 获取均衡器设置
   */
  getEqualizer(): number[];
  
  /**
   * 获取音频可视化数据
   */
  getVisualizationData(): Uint8Array;
}

type LoopMode = 'none' | 'one' | 'all' | 'shuffle';

interface AudioMetadata {
  title?: string;
  artist?: string;
  album?: string;
  year?: number;
  genre?: string;
  coverArt?: string; // URL or data URL
  duration?: number;
  bitrate?: number;
  sampleRate?: number;
}

/**
 * 音乐播放器事件
 */
interface AudioPlayerEvents extends MediaPlayerEvents {
  'trackchange': (index: number, file: FileInfo) => void;
  'playlistchange': (playlist: FileInfo[]) => void;
  'loopmodechange': (mode: LoopMode) => void;
  'metadataloaded': (metadata: AudioMetadata) => void;
  'visualizationupdate': (data: Uint8Array) => void;
}
```

## 4. 查看器接口

### 4.1 图片查看器接口

```typescript
/**
 * 图片查看器接口
 */
interface IImageViewer extends IViewerTool {
  /**
   * 放大
   * @param factor 放大倍数（默认 1.2）
   */
  zoomIn(factor?: number): void;
  
  /**
   * 缩小
   * @param factor 缩小倍数（默认 0.8）
   */
  zoomOut(factor?: number): void;
  
  /**
   * 设置缩放级别
   * @param level 缩放级别（1 = 100%）
   */
  setZoom(level: number): void;
  
  /**
   * 获取当前缩放级别
   */
  getZoom(): number;
  
  /**
   * 适应窗口
   */
  fitToWindow(): void;
  
  /**
   * 实际大小
   */
  actualSize(): void;
  
  /**
   * 旋转
   * @param angle 旋转角度（90、180、270 等）
   */
  rotate(angle: number): void;
  
  /**
   * 水平翻转
   */
  flipHorizontal(): void;
  
  /**
   * 垂直翻转
   */
  flipVertical(): void;
  
  /**
   * 加载图片集合（幻灯片模式）
   */
  loadGallery(images: FileInfo[]): Promise<void>;
  
  /**
   * 显示下一张
   */
  next(): void;
  
  /**
   * 显示上一张
   */
  previous(): void;
  
  /**
   * 跳转到指定图片
   */
  goto(index: number): void;
  
  /**
   * 开始幻灯片播放
   * @param interval 切换间隔（毫秒）
   */
  startSlideshow(interval?: number): void;
  
  /**
   * 停止幻灯片播放
   */
  stopSlideshow(): void;
  
  /**
   * 获取图片信息
   */
  getImageInfo(): ImageInfo;
}

interface ImageInfo {
  width: number;
  height: number;
  size: number;
  format: string;
  colorSpace?: string;
  hasAlpha?: boolean;
  exif?: any;
}

/**
 * 图片查看器事件
 */
interface ImageViewerEvents {
  'zoomchange': (level: number) => void;
  'rotate': (angle: number) => void;
  'imagechange': (index: number, file: FileInfo) => void;
  'slideshow': (playing: boolean) => void;
}
```

### 4.2 代码查看器接口

```typescript
/**
 * 代码查看器接口
 */
interface ICodeViewer extends IViewerTool {
  /**
   * 设置语言
   */
  setLanguage(language: string): void;
  
  /**
   * 获取当前语言
   */
  getLanguage(): string;
  
  /**
   * 设置主题
   */
  setTheme(theme: string): void;
  
  /**
   * 显示/隐藏行号
   */
  showLineNumbers(show: boolean): void;
  
  /**
   * 跳转到指定行
   */
  gotoLine(line: number): void;
  
  /**
   * 搜索
   */
  search(query: string, options?: SearchOptions): SearchResult[];
  
  /**
   * 高亮指定行
   */
  highlightLines(lines: number[]): void;
  
  /**
   * 折叠代码块
   */
  fold(startLine: number, endLine: number): void;
  
  /**
   * 展开代码块
   */
  unfold(startLine: number, endLine: number): void;
  
  /**
   * 复制代码
   */
  copyCode(): Promise<void>;
  
  /**
   * 获取选中的文本
   */
  getSelectedText(): string;
}

interface SearchOptions {
  caseSensitive?: boolean;
  wholeWord?: boolean;
  regex?: boolean;
}

interface SearchResult {
  line: number;
  column: number;
  match: string;
}
```

### 4.3 PDF 查看器接口

```typescript
/**
 * PDF 查看器接口
 */
interface IPDFViewer extends IViewerTool {
  /**
   * 跳转到指定页
   */
  gotoPage(page: number): Promise<void>;
  
  /**
   * 下一页
   */
  nextPage(): void;
  
  /**
   * 上一页
   */
  previousPage(): void;
  
  /**
   * 获取当前页码
   */
  getCurrentPage(): number;
  
  /**
   * 获取总页数
   */
  getTotalPages(): number;
  
  /**
   * 设置缩放
   * @param scale 缩放比例或预设值
   */
  setScale(scale: number | 'page-fit' | 'page-width' | 'page-height' | 'auto'): void;
  
  /**
   * 获取缩放比例
   */
  getScale(): number;
  
  /**
   * 旋转页面
   * @param angle 旋转角度（90 的倍数）
   */
  rotatePage(angle: number): void;
  
  /**
   * 搜索文本
   */
  searchText(query: string): Promise<PDFSearchResult[]>;
  
  /**
   * 获取文档信息
   */
  getDocumentInfo(): PDFDocumentInfo;
  
  /**
   * 获取目录
   */
  getOutline(): PDFOutlineNode[];
  
  /**
   * 打印
   */
  print(): Promise<void>;
}

interface PDFSearchResult {
  page: number;
  text: string;
  matchIndex: number;
}

interface PDFDocumentInfo {
  title?: string;
  author?: string;
  subject?: string;
  keywords?: string;
  creator?: string;
  producer?: string;
  creationDate?: Date;
  modificationDate?: Date;
}

interface PDFOutlineNode {
  title: string;
  page: number;
  children?: PDFOutlineNode[];
}
```

### 4.4 Markdown 渲染器接口

```typescript
/**
 * Markdown 渲染器接口
 */
interface IMarkdownRenderer extends IViewerTool {
  /**
   * 设置渲染选项
   */
  setOptions(options: MarkdownOptions): void;
  
  /**
   * 显示/隐藏目录
   */
  showToc(show: boolean): void;
  
  /**
   * 跳转到标题
   */
  gotoHeading(id: string): void;
  
  /**
   * 获取所有标题
   */
  getHeadings(): MarkdownHeading[];
  
  /**
   * 设置代码主题
   */
  setCodeTheme(theme: string): void;
}

interface MarkdownOptions {
  gfm?: boolean;           // GitHub Flavored Markdown
  breaks?: boolean;        // 自动换行
  mermaid?: boolean;       // Mermaid 图表
  katex?: boolean;         // 数学公式
  emoji?: boolean;         // Emoji 支持
}

interface MarkdownHeading {
  level: number;           // 1-6
  text: string;
  id: string;
}
```

## 5. 工具控制器

### 5.1 标准控制器实现

```typescript
/**
 * 标准工具控制器
 */
class StandardToolController implements ToolController {
  private commands: Map<string, Function> = new Map();
  private properties: Map<string, any> = new Map();
  
  constructor(private tool: IViewerTool) {
    this.registerStandardCommands();
  }
  
  /**
   * 注册命令
   */
  registerCommand(name: string, handler: Function): void {
    this.commands.set(name, handler);
  }
  
  /**
   * 执行命令
   */
  async execute(command: string, ...args: any[]): Promise<any> {
    const handler = this.commands.get(command);
    
    if (!handler) {
      throw new Error(`Unknown command: ${command}`);
    }
    
    return handler(...args);
  }
  
  /**
   * 获取属性
   */
  get(property: string): any {
    return this.properties.get(property);
  }
  
  /**
   * 设置属性
   */
  set(property: string, value: any): void {
    this.properties.set(property, value);
    this.tool.emit('propertychange', { property, value });
  }
  
  private registerStandardCommands(): void {
    // 通用命令
    this.registerCommand('getState', () => this.tool.getState());
    
    // 媒体播放器命令
    if (this.isMediaPlayer(this.tool)) {
      this.registerCommand('play', () => this.tool.play());
      this.registerCommand('pause', () => this.tool.pause());
      this.registerCommand('stop', () => this.tool.stop());
      this.registerCommand('seek', (time: number) => this.tool.seek(time));
      this.registerCommand('setVolume', (vol: number) => this.tool.setVolume(vol));
    }
    
    // 图片查看器命令
    if (this.isImageViewer(this.tool)) {
      this.registerCommand('zoomIn', () => this.tool.zoomIn());
      this.registerCommand('zoomOut', () => this.tool.zoomOut());
      this.registerCommand('rotate', (angle: number) => this.tool.rotate(angle));
    }
    
    // ... 更多命令注册
  }
  
  private isMediaPlayer(tool: any): tool is IMediaPlayer {
    return 'play' in tool && 'pause' in tool;
  }
  
  private isImageViewer(tool: any): tool is IImageViewer {
    return 'zoomIn' in tool && 'zoomOut' in tool;
  }
}
```

### 5.2 快捷键绑定

```typescript
/**
 * 工具快捷键配置
 */
interface ToolKeyBindings {
  [action: string]: string | string[];
}

/**
 * 媒体播放器默认快捷键
 */
const MediaPlayerKeyBindings: ToolKeyBindings = {
  'play-pause': 'Space',
  'seek-forward': 'ArrowRight',
  'seek-backward': 'ArrowLeft',
  'volume-up': 'ArrowUp',
  'volume-down': 'ArrowDown',
  'mute': 'M',
  'fullscreen': 'F',
  'speed-increase': '>',
  'speed-decrease': '<'
};

/**
 * 图片查看器默认快捷键
 */
const ImageViewerKeyBindings: ToolKeyBindings = {
  'zoom-in': ['+', '='],
  'zoom-out': '-',
  'fit-window': '0',
  'actual-size': '1',
  'rotate-right': 'R',
  'rotate-left': 'Shift+R',
  'next': ['ArrowRight', 'PageDown'],
  'previous': ['ArrowLeft', 'PageUp'],
  'fullscreen': 'F'
};
```

## 6. 事件系统

### 6.1 事件发射器实现

```typescript
/**
 * 事件发射器
 */
class EventEmitter {
  private listeners: Map<string, Set<Function>> = new Map();
  
  on(event: string, handler: Function): void {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set());
    }
    this.listeners.get(event)!.add(handler);
  }
  
  off(event: string, handler: Function): void {
    const handlers = this.listeners.get(event);
    if (handlers) {
      handlers.delete(handler);
    }
  }
  
  emit(event: string, ...args: any[]): void {
    const handlers = this.listeners.get(event);
    if (handlers) {
      handlers.forEach(handler => {
        try {
          handler(...args);
        } catch (error) {
          console.error(`Error in event handler for ${event}:`, error);
        }
      });
    }
  }
  
  once(event: string, handler: Function): void {
    const onceHandler = (...args: any[]) => {
      handler(...args);
      this.off(event, onceHandler);
    };
    this.on(event, onceHandler);
  }
  
  removeAllListeners(event?: string): void {
    if (event) {
      this.listeners.delete(event);
    } else {
      this.listeners.clear();
    }
  }
}
```

### 6.2 标准事件定义

```typescript
/**
 * 工具生命周期事件
 */
interface ToolLifecycleEvents {
  'init': () => void;
  'destroy': () => void;
  'load': (file: FileInfo) => void;
  'unload': () => void;
  'error': (error: Error) => void;
}

/**
 * 工具状态事件
 */
interface ToolStateEvents {
  'statechange': (state: ToolState) => void;
  'propertychange': (change: { property: string; value: any }) => void;
}

/**
 * 用户交互事件
 */
interface ToolInteractionEvents {
  'click': (event: MouseEvent) => void;
  'doubleclick': (event: MouseEvent) => void;
  'contextmenu': (event: MouseEvent) => void;
  'keydown': (event: KeyboardEvent) => void;
}
```

## 7. 工具设置

### 7.1 设置定义

```typescript
/**
 * 工具设置项
 */
interface ToolSettingItem {
  key: string;
  type: 'string' | 'number' | 'boolean' | 'select' | 'color';
  label: string;
  description?: string;
  default: any;
  
  // 数字类型选项
  min?: number;
  max?: number;
  step?: number;
  
  // 选择类型选项
  options?: Array<{ value: any; label: string }>;
  
  // 验证
  validation?: (value: any) => boolean | string;
}

/**
 * 工具设置管理器
 */
class ToolSettingsManager {
  private settings: Map<string, any> = new Map();
  private definitions: ToolSettingItem[];
  
  constructor(definitions: ToolSettingItem[]) {
    this.definitions = definitions;
    this.loadDefaults();
  }
  
  get(key: string): any {
    return this.settings.get(key);
  }
  
  set(key: string, value: any): void {
    const def = this.definitions.find(d => d.key === key);
    if (!def) {
      throw new Error(`Unknown setting: ${key}`);
    }
    
    if (def.validation) {
      const result = def.validation(value);
      if (result !== true) {
        throw new Error(typeof result === 'string' ? result : 'Invalid value');
      }
    }
    
    this.settings.set(key, value);
    this.save();
  }
  
  getAll(): Record<string, any> {
    const result: Record<string, any> = {};
    this.settings.forEach((value, key) => {
      result[key] = value;
    });
    return result;
  }
  
  reset(): void {
    this.loadDefaults();
    this.save();
  }
  
  private loadDefaults(): void {
    this.definitions.forEach(def => {
      this.settings.set(def.key, def.default);
    });
  }
  
  private save(): void {
    // 保存到本地存储
  }
}
```

## 8. 完整示例：视频播放器实现

```typescript
/**
 * 基于 Video.js 的视频播放器实现
 */
import videojs from 'video.js';

export default class VideoJSPlayer extends EventEmitter implements IVideoPlayer {
  readonly metadata: ViewerToolMetadata = {
    id: 'com.chips.video-player.videojs',
    name: 'Video.js Player',
    version: '1.0.0',
    supportedTypes: ['video/mp4', 'video/webm', 'video/ogg'],
    supportedExtensions: ['.mp4', '.webm', '.ogv'],
    capabilities: {
      playback: true,
      fullscreen: true,
      zoom: false,
      rotation: false
    }
  };
  
  private context!: ToolContext;
  private player: videojs.Player | null = null;
  private container: HTMLElement | null = null;
  
  async init(context: ToolContext): Promise<void> {
    this.context = context;
    this.context.logger.info('VideoJS Player initialized');
  }
  
  async destroy(): Promise<void> {
    await this.unload();
  }
  
  supports(file: FileInfo): boolean {
    return this.metadata.supportedTypes.includes(file.mimeType);
  }
  
  async load(
    file: FileInfo,
    container: HTMLElement,
    options?: LoadOptions
  ): Promise<LoadResult> {
    try {
      // 创建视频元素
      const video = document.createElement('video');
      video.className = 'video-js';
      container.appendChild(video);
      
      // 初始化 Video.js
      this.player = videojs(video, {
        controls: true,
        autoplay: options?.autoStart || false,
        preload: 'auto'
      });
      
      // 加载视频源
      const blobURL = await file.toBlobURL();
      this.player.src({ type: file.mimeType, src: blobURL });
      
      // 绑定事件
      this.bindEvents();
      
      this.container = container;
      
      return {
        success: true,
        element: video,
        controller: new StandardToolController(this)
      };
    } catch (error) {
      return {
        success: false,
        error: error as Error
      };
    }
  }
  
  async unload(): Promise<void> {
    if (this.player) {
      this.player.dispose();
      this.player = null;
    }
    
    if (this.container) {
      this.container.innerHTML = '';
      this.container = null;
    }
  }
  
  getState(): ToolState {
    return {
      loaded: this.player !== null,
      active: this.player?.paused() === false,
      currentTime: this.getCurrentTime(),
      duration: this.getDuration()
    };
  }
  
  // IMediaPlayer 接口实现
  
  async play(): Promise<void> {
    await this.player?.play();
  }
  
  async pause(): Promise<void> {
    this.player?.pause();
  }
  
  async stop(): Promise<void> {
    this.player?.pause();
    this.player?.currentTime(0);
  }
  
  async seek(time: number): Promise<void> {
    this.player?.currentTime(time);
  }
  
  setVolume(volume: number): void {
    this.player?.volume(volume);
  }
  
  getVolume(): number {
    return this.player?.volume() || 0;
  }
  
  mute(muted: boolean): void {
    this.player?.muted(muted);
  }
  
  isMuted(): boolean {
    return this.player?.muted() || false;
  }
  
  setPlaybackRate(rate: number): void {
    this.player?.playbackRate(rate);
  }
  
  getPlaybackRate(): number {
    return this.player?.playbackRate() || 1;
  }
  
  getCurrentTime(): number {
    return this.player?.currentTime() || 0;
  }
  
  getDuration(): number {
    return this.player?.duration() || 0;
  }
  
  isPlaying(): boolean {
    return this.player?.paused() === false;
  }
  
  isEnded(): boolean {
    return this.player?.ended() || false;
  }
  
  getBuffered(): number {
    const buffered = this.player?.buffered();
    if (buffered && buffered.length > 0) {
      return (buffered.end(0) / this.getDuration()) * 100;
    }
    return 0;
  }
  
  // IVideoPlayer 接口实现
  
  getVideoSize(): { width: number; height: number } {
    return {
      width: this.player?.videoWidth() || 0,
      height: this.player?.videoHeight() || 0
    };
  }
  
  async toggleFullscreen(): Promise<void> {
    if (this.isFullscreen()) {
      this.player?.exitFullscreen();
    } else {
      await this.player?.requestFullscreen();
    }
  }
  
  isFullscreen(): boolean {
    return this.player?.isFullscreen() || false;
  }
  
  async loadSubtitle(subtitle: string | File): Promise<void> {
    // 实现字幕加载
  }
  
  showSubtitle(show: boolean): void {
    const tracks = this.player?.textTracks();
    if (tracks) {
      for (let i = 0; i < tracks.length; i++) {
        tracks[i].mode = show ? 'showing' : 'disabled';
      }
    }
  }
  
  setSubtitleTrack(trackIndex: number): void {
    // 实现字幕轨道切换
  }
  
  getSubtitleTracks(): SubtitleTrack[] {
    // 实现获取字幕轨道
    return [];
  }
  
  setAudioTrack(trackIndex: number): void {
    // 实现音轨切换
  }
  
  getAudioTracks(): AudioTrack[] {
    // 实现获取音轨
    return [];
  }
  
  async takeScreenshot(): Promise<string> {
    const video = this.player?.el().querySelector('video');
    if (!video) throw new Error('No video element');
    
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx?.drawImage(video, 0, 0);
    
    return canvas.toDataURL('image/png');
  }
  
  async togglePictureInPicture(): Promise<void> {
    // 实现画中画
  }
  
  isPictureInPicture(): boolean {
    return false;
  }
  
  // 私有方法
  
  private bindEvents(): void {
    if (!this.player) return;
    
    this.player.on('play', () => this.emit('play'));
    this.player.on('pause', () => this.emit('pause'));
    this.player.on('ended', () => this.emit('ended'));
    this.player.on('timeupdate', () => {
      this.emit('timeupdate', this.getCurrentTime());
    });
    this.player.on('durationchange', () => {
      this.emit('durationchange', this.getDuration());
    });
    this.player.on('volumechange', () => {
      this.emit('volumechange', this.getVolume());
    });
    this.player.on('error', (err) => {
      this.emit('error', err);
    });
  }
}
```

## 9. 总结

查看工具接口为 Chips Viewer 提供了统一、完整、可扩展的工具集成标准。通过这套接口：

- **开发者**可以轻松开发各种查看工具插件
- **用户**可以获得一致的使用体验
- **查看器**可以灵活地集成和管理各种工具

接口设计遵循开放封闭原则，既保证了核心功能的稳定性，又为扩展提供了充分的灵活性。

# 代码结构

## 1. 项目结构概述

Chips Viewer 采用模块化的代码组织方式,清晰的目录结构便于开发和维护。

```
chips-viewer/
├── src/                      # 源代码
│   ├── main/                 # 主进程（Electron）
│   ├── renderer/             # 渲染进程/Web 前端
│   ├── common/               # 共享代码
│   └── plugins/              # 内置插件
├── dist/                     # 构建输出
├── tests/                    # 测试代码
├── docs/                     # 文档
├── resources/                # 资源文件
├── scripts/                  # 构建脚本
├── .github/                  # GitHub 配置
├── package.json              # NPM 配置
├── tsconfig.json             # TypeScript 配置
├── webpack.config.js         # Webpack 配置
├── electron-builder.json     # Electron Builder 配置
└── README.md                 # 说明文档
```

## 2. 源代码结构 (src/)

### 2.1 整体结构

```
src/
├── main/                     # Electron 主进程
│   ├── index.ts             # 主进程入口
│   ├── window.ts            # 窗口管理
│   ├── menu.ts              # 菜单定义
│   ├── ipc.ts               # IPC 通信处理
│   ├── file-handler.ts      # 文件关联处理
│   └── updater.ts           # 自动更新
│
├── renderer/                 # 渲染进程/Web 前端
│   ├── index.html           # HTML 入口
│   ├── index.ts             # JavaScript 入口
│   ├── App.tsx              # 根组件
│   ├── components/          # React 组件
│   ├── pages/               # 页面组件
│   ├── styles/              # 样式文件
│   ├── hooks/               # 自定义 Hooks
│   ├── utils/               # 工具函数
│   └── assets/              # 静态资源
│
├── common/                   # 共享代码
│   ├── types/               # TypeScript 类型定义
│   ├── constants/           # 常量定义
│   ├── interfaces/          # 接口定义
│   └── utils/               # 共享工具函数
│
└── plugins/                  # 内置插件
    ├── video-player/        # 视频播放器
    ├── audio-player/        # 音频播放器
    ├── image-viewer/        # 图片查看器
    ├── code-viewer/         # 代码查看器
    ├── pdf-viewer/          # PDF 查看器
    ├── markdown-renderer/   # Markdown 渲染器
    └── text-viewer/         # 文本查看器
```

### 2.2 主进程 (main/)

```
main/
├── index.ts                  # 主进程入口
│   - 应用初始化
│   - 创建主窗口
│   - 注册全局快捷键
│   - 设置应用菜单
│
├── window.ts                 # 窗口管理
│   - createWindow()          # 创建窗口
│   - WindowManager class     # 窗口管理器
│   - 窗口状态保存/恢复
│
├── menu.ts                   # 菜单定义
│   - createApplicationMenu() # 创建应用菜单
│   - createContextMenu()     # 创建上下文菜单
│   - 菜单事件处理
│
├── ipc.ts                    # IPC 通信处理
│   - 注册 IPC 处理器
│   - 主进程 API 实现
│   - 与渲染进程通信
│
├── file-handler.ts           # 文件关联处理
│   - 注册文件关联
│   - 处理文件打开请求
│   - 协议处理（chips://）
│
└── updater.ts                # 自动更新
    - 检查更新
    - 下载更新
    - 安装更新
```

#### 2.2.1 主进程入口 (index.ts)

```typescript
import { app, BrowserWindow } from 'electron';
import { createWindow } from './window';
import { setupMenu } from './menu';
import { setupIPC } from './ipc';
import { registerFileHandler } from './file-handler';
import { checkForUpdates } from './updater';

// 应用准备就绪
app.whenReady().then(async () => {
  // 创建主窗口
  const mainWindow = await createWindow();
  
  // 设置菜单
  setupMenu(mainWindow);
  
  // 设置 IPC
  setupIPC(mainWindow);
  
  // 注册文件处理器
  registerFileHandler();
  
  // 检查更新
  checkForUpdates();
  
  // macOS 特殊处理
  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

// 所有窗口关闭
app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

// 处理第二个实例
app.on('second-instance', (event, commandLine) => {
  // 如果用户尝试打开第二个实例,聚焦到主窗口
  const mainWindow = BrowserWindow.getAllWindows()[0];
  if (mainWindow) {
    if (mainWindow.isMinimized()) mainWindow.restore();
    mainWindow.focus();
  }
});

// 单实例锁
const gotTheLock = app.requestSingleInstanceLock();
if (!gotTheLock) {
  app.quit();
}
```

### 2.3 渲染进程 (renderer/)

```
renderer/
├── index.html                # HTML 入口
├── index.ts                  # JavaScript 入口
├── App.tsx                   # 根组件
│
├── components/               # React 组件
│   ├── Layout/              # 布局组件
│   │   ├── Toolbar.tsx      # 工具栏
│   │   ├── Sidebar.tsx      # 侧边栏
│   │   ├── ContentArea.tsx  # 内容区域
│   │   └── StatusBar.tsx    # 状态栏
│   │
│   ├── Viewer/              # 查看器组件
│   │   ├── CardViewer.tsx   # 卡片查看器
│   │   ├── BoxViewer.tsx    # 箱子查看器
│   │   └── FileViewer.tsx   # 文件查看器
│   │
│   ├── Controls/            # 控制组件
│   │   ├── PlayButton.tsx   # 播放按钮
│   │   ├── VolumeControl.tsx # 音量控制
│   │   ├── ProgressBar.tsx  # 进度条
│   │   └── ZoomControl.tsx  # 缩放控制
│   │
│   └── Common/              # 通用组件
│       ├── Button.tsx       # 按钮
│       ├── Modal.tsx        # 模态框
│       ├── Dropdown.tsx     # 下拉菜单
│       └── Tooltip.tsx      # 提示框
│
├── pages/                    # 页面组件
│   ├── ViewerPage.tsx       # 查看器页面
│   ├── SettingsPage.tsx     # 设置页面
│   ├── PluginsPage.tsx      # 插件页面
│   └── AboutPage.tsx        # 关于页面
│
├── core/                     # 核心模块
│   ├── viewer/              # 查看器核心
│   │   ├── ViewerApp.ts     # 查看器应用
│   │   ├── CardRenderer.ts  # 卡片渲染器
│   │   ├── BoxRenderer.ts   # 箱子渲染器
│   │   └── ThemeManager.ts  # 主题管理器
│   │
│   ├── plugins/             # 插件系统
│   │   ├── PluginManager.ts # 插件管理器
│   │   ├── PluginLoader.ts  # 插件加载器
│   │   └── PluginDispatcher.ts # 插件调度器
│   │
│   └── engine/              # 渲染引擎
│       ├── RenderEngine.ts  # 渲染引擎
│       ├── LayoutEngine.ts  # 布局引擎
│       └── ThemeApplier.ts  # 主题应用器
│
├── services/                 # 服务层
│   ├── FileService.ts       # 文件服务
│   ├── ConfigService.ts     # 配置服务
│   ├── PluginService.ts     # 插件服务
│   └── ThemeService.ts      # 主题服务
│
├── stores/                   # 状态管理
│   ├── ViewerStore.ts       # 查看器状态
│   ├── PluginStore.ts       # 插件状态
│   ├── ThemeStore.ts        # 主题状态
│   └── ConfigStore.ts       # 配置状态
│
├── hooks/                    # 自定义 Hooks
│   ├── useViewer.ts         # 使用查看器
│   ├── usePlugin.ts         # 使用插件
│   ├── useTheme.ts          # 使用主题
│   └── useKeyboard.ts       # 使用键盘
│
├── utils/                    # 工具函数
│   ├── file.ts              # 文件工具
│   ├── format.ts            # 格式化工具
│   ├── validation.ts        # 验证工具
│   └── async.ts             # 异步工具
│
└── styles/                   # 样式文件
    ├── global.css           # 全局样式
    ├── variables.css        # CSS 变量
    ├── themes/              # 主题样式
    └── components/          # 组件样式
```

#### 2.3.1 应用入口 (index.ts)

```typescript
import React from 'react';
import ReactDOM from 'react-dom/client';
import { App } from './App';
import { ViewerApp } from './core/viewer/ViewerApp';
import './styles/global.css';

// 初始化查看器应用
const viewerApp = ViewerApp.getInstance();
await viewerApp.initialize();

// 渲染 React 应用
const root = ReactDOM.createRoot(
  document.getElementById('root') as HTMLElement
);

root.render(
  <React.StrictMode>
    <App viewerApp={viewerApp} />
  </React.StrictMode>
);
```

#### 2.3.2 根组件 (App.tsx)

```typescript
import React from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { ViewerProvider } from './contexts/ViewerContext';
import { ThemeProvider } from './contexts/ThemeContext';
import { Layout } from './components/Layout';
import { ViewerPage } from './pages/ViewerPage';
import { SettingsPage } from './pages/SettingsPage';
import { PluginsPage } from './pages/PluginsPage';
import { AboutPage } from './pages/AboutPage';
import { ViewerApp } from './core/viewer/ViewerApp';

interface AppProps {
  viewerApp: ViewerApp;
}

export const App: React.FC<AppProps> = ({ viewerApp }) => {
  return (
    <ViewerProvider viewerApp={viewerApp}>
      <ThemeProvider>
        <BrowserRouter>
          <Layout>
            <Routes>
              <Route path="/" element={<ViewerPage />} />
              <Route path="/settings" element={<SettingsPage />} />
              <Route path="/plugins" element={<PluginsPage />} />
              <Route path="/about" element={<AboutPage />} />
            </Routes>
          </Layout>
        </BrowserRouter>
      </ThemeProvider>
    </ViewerProvider>
  );
};
```

### 2.4 共享代码 (common/)

```
common/
├── types/                    # TypeScript 类型
│   ├── card.ts              # 卡片类型
│   ├── plugin.ts            # 插件类型
│   ├── theme.ts             # 主题类型
│   ├── viewer.ts            # 查看器类型
│   └── index.ts             # 类型导出
│
├── constants/                # 常量定义
│   ├── events.ts            # 事件常量
│   ├── commands.ts          # 命令常量
│   ├── shortcuts.ts         # 快捷键常量
│   └── index.ts             # 常量导出
│
├── interfaces/               # 接口定义
│   ├── IViewerTool.ts       # 查看工具接口
│   ├── ICardRenderer.ts     # 卡片渲染器接口
│   ├── IPluginManager.ts    # 插件管理器接口
│   └── index.ts             # 接口导出
│
└── utils/                    # 共享工具函数
    ├── path.ts              # 路径工具
    ├── mime.ts              # MIME 类型工具
    ├── version.ts           # 版本比较工具
    └── index.ts             # 工具导出
```

#### 2.4.1 类型定义示例

```typescript
// types/card.ts
export enum CardType {
  RichText = 'richtext',
  Markdown = 'markdown',
  Image = 'image',
  Video = 'video',
  Audio = 'audio',
  Code = 'code',
  List = 'list',
  Rating = 'rating',
  Web = 'web',
  Composite = 'composite'
}

export interface Card {
  id: string;
  type: CardType;
  version: string;
  metadata: CardMetadata;
  content: any;
  children?: Card[];
}

export interface CardMetadata {
  title?: string;
  description?: string;
  tags?: string[];
  createdAt: number;
  modifiedAt: number;
  author?: string;
}
```

### 2.5 内置插件 (plugins/)

每个插件都有独立的目录结构：

```
plugins/video-player/
├── manifest.json             # 插件清单
├── index.ts                  # 插件入口
├── VideoPlayer.ts            # 播放器实现
├── components/               # UI 组件
│   ├── Controls.tsx         # 控制器
│   ├── ProgressBar.tsx      # 进度条
│   └── Settings.tsx         # 设置面板
├── styles/                   # 样式
│   └── player.css
├── assets/                   # 资源
│   └── icons/
├── README.md                 # 说明文档
└── package.json              # 依赖配置
```

#### 2.5.1 插件入口示例

```typescript
// plugins/video-player/index.ts
import { IViewerToolPlugin } from '@/common/interfaces';
import { VideoPlayer } from './VideoPlayer';

export default class VideoPlayerPlugin implements IViewerToolPlugin {
  private player: VideoPlayer;
  
  constructor() {
    this.player = new VideoPlayer();
  }
  
  get manifest() {
    return require('./manifest.json');
  }
  
  async init(context: PluginContext): Promise<void> {
    await this.player.init(context);
  }
  
  async destroy(): Promise<void> {
    await this.player.destroy();
  }
  
  canHandle(file: FileInfo): boolean {
    return this.player.canHandle(file);
  }
  
  async render(
    file: FileInfo,
    container: HTMLElement,
    options?: RenderOptions
  ): Promise<RenderResult> {
    return this.player.render(file, container, options);
  }
  
  dispose(): void {
    this.player.dispose();
  }
}
```

## 3. 核心模块详解

### 3.1 ViewerApp (查看器应用)

```typescript
// core/viewer/ViewerApp.ts
export class ViewerApp {
  private static instance: ViewerApp;
  private pluginManager: PluginManager;
  private themeManager: ThemeManager;
  private cardRenderer: CardRenderer;
  private boxRenderer: BoxRenderer;
  private eventBus: EventBus;
  
  private constructor() {
    this.eventBus = new EventBus();
    this.pluginManager = new PluginManager(this.eventBus);
    this.themeManager = new ThemeManager(this.eventBus);
    this.cardRenderer = new CardRenderer(this.pluginManager, this.themeManager);
    this.boxRenderer = new BoxRenderer(this.pluginManager, this.themeManager);
  }
  
  static getInstance(): ViewerApp {
    if (!ViewerApp.instance) {
      ViewerApp.instance = new ViewerApp();
    }
    return ViewerApp.instance;
  }
  
  async initialize(): Promise<void> {
    // 加载配置
    await this.loadConfig();
    
    // 初始化插件系统
    await this.pluginManager.initialize();
    
    // 加载内置插件
    await this.loadBuiltinPlugins();
    
    // 初始化主题
    await this.themeManager.initialize();
    
    // 触发初始化完成事件
    this.eventBus.emit('initialized');
  }
  
  async openCard(path: string): Promise<void> {
    // 读取卡片文件
    const cardData = await FileService.readCard(path);
    
    // 解析卡片
    const card = CardParser.parse(cardData);
    
    // 渲染卡片
    await this.cardRenderer.render(card);
    
    // 更新历史记录
    this.addToHistory(path);
  }
  
  async openBox(path: string): Promise<void> {
    // 读取箱子配置
    const boxConfig = await FileService.readBoxConfig(path);
    
    // 扫描箱子中的卡片
    const cards = await FileService.scanCards(path);
    
    // 渲染箱子
    await this.boxRenderer.render(cards, boxConfig);
  }
  
  // 更多方法...
}
```

### 3.2 PluginManager (插件管理器)

```typescript
// core/plugins/PluginManager.ts
export class PluginManager {
  private plugins: Map<string, LoadedPlugin> = new Map();
  private pluginLoader: PluginLoader;
  private pluginDispatcher: PluginDispatcher;
  
  constructor(private eventBus: EventBus) {
    this.pluginLoader = new PluginLoader();
    this.pluginDispatcher = new PluginDispatcher(this);
  }
  
  async initialize(): Promise<void> {
    // 加载插件注册表
    const registry = await this.loadRegistry();
    
    // 加载已安装的插件
    for (const pluginId of registry.installed) {
      await this.loadPlugin(pluginId);
    }
  }
  
  async loadPlugin(pluginId: string): Promise<void> {
    // 加载插件代码
    const plugin = await this.pluginLoader.load(pluginId);
    
    // 初始化插件
    await plugin.init(this.createPluginContext(pluginId));
    
    // 注册插件
    this.registerPlugin(pluginId, plugin);
    
    // 触发事件
    this.eventBus.emit('plugin-loaded', pluginId);
  }
  
  getPlugin(pluginId: string): IViewerToolPlugin | null {
    return this.plugins.get(pluginId)?.instance || null;
  }
  
  async dispatch(
    file: FileInfo,
    container: HTMLElement,
    options?: RenderOptions
  ): Promise<RenderResult> {
    return this.pluginDispatcher.dispatch(file, container, options);
  }
  
  // 更多方法...
}
```

### 3.3 CardRenderer (卡片渲染器)

```typescript
// core/viewer/CardRenderer.ts
export class CardRenderer {
  private rendererFactory: RendererFactory;
  private themeApplier: ThemeApplier;
  
  constructor(
    private pluginManager: PluginManager,
    private themeManager: ThemeManager
  ) {
    this.rendererFactory = new RendererFactory(pluginManager);
    this.themeApplier = new ThemeApplier();
  }
  
  async render(card: Card, container?: HTMLElement): Promise<void> {
    // 获取或创建容器
    const target = container || document.getElementById('content-area')!;
    
    // 清空容器
    target.innerHTML = '';
    
    // 获取渲染器
    const renderer = this.rendererFactory.getRenderer(card.type);
    
    // 渲染卡片
    const result = await renderer.render(card, target, {
      theme: this.themeManager.getCurrentTheme()
    });
    
    // 应用主题
    this.themeApplier.apply(
      this.themeManager.getCurrentTheme(),
      result.element
    );
  }
  
  // 更多方法...
}
```

## 4. 状态管理

使用 Zustand 进行状态管理：

```typescript
// stores/ViewerStore.ts
import create from 'zustand';

interface ViewerState {
  currentCard: Card | null;
  currentBox: Box | null;
  loading: boolean;
  error: Error | null;
  
  // Actions
  setCurrentCard: (card: Card | null) => void;
  setCurrentBox: (box: Box | null) => void;
  setLoading: (loading: boolean) => void;
  setError: (error: Error | null) => void;
}

export const useViewerStore = create<ViewerState>((set) => ({
  currentCard: null,
  currentBox: null,
  loading: false,
  error: null,
  
  setCurrentCard: (card) => set({ currentCard: card }),
  setCurrentBox: (box) => set({ currentBox: box }),
  setLoading: (loading) => set({ loading }),
  setError: (error) => set({ error })
}));
```

## 5. 构建配置

### 5.1 Webpack 配置

```javascript
// webpack.config.js
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

module.exports = {
  mode: process.env.NODE_ENV || 'development',
  
  entry: {
    main: './src/main/index.ts',
    renderer: './src/renderer/index.ts'
  },
  
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: '[name]/[name].js'
  },
  
  target: {
    main: 'electron-main',
    renderer: 'electron-renderer'
  },
  
  module: {
    rules: [
      {
        test: /\.tsx?$/,
        use: 'ts-loader',
        exclude: /node_modules/
      },
      {
        test: /\.css$/,
        use: [MiniCssExtractPlugin.loader, 'css-loader']
      },
      {
        test: /\.(png|jpg|gif|svg)$/,
        type: 'asset/resource'
      }
    ]
  },
  
  resolve: {
    extensions: ['.ts', '.tsx', '.js', '.jsx'],
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@common': path.resolve(__dirname, 'src/common'),
      '@renderer': path.resolve(__dirname, 'src/renderer')
    }
  },
  
  plugins: [
    new HtmlWebpackPlugin({
      template: './src/renderer/index.html',
      chunks: ['renderer']
    }),
    new MiniCssExtractPlugin({
      filename: '[name]/[name].css'
    })
  ]
};
```

### 5.2 TypeScript 配置

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM"],
    "jsx": "react-jsx",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": false,
    "outDir": "./dist",
    "baseUrl": "./src",
    "paths": {
      "@/*": ["*"],
      "@common/*": ["common/*"],
      "@renderer/*": ["renderer/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

## 6. 测试结构

```
tests/
├── unit/                     # 单元测试
│   ├── core/                # 核心模块测试
│   ├── plugins/             # 插件测试
│   └── utils/               # 工具函数测试
│
├── integration/              # 集成测试
│   ├── viewer/              # 查看器集成测试
│   └── plugins/             # 插件集成测试
│
├── e2e/                      # 端到端测试
│   ├── viewer.spec.ts       # 查看器 E2E 测试
│   └── plugins.spec.ts      # 插件 E2E 测试
│
└── fixtures/                 # 测试数据
    ├── cards/               # 测试卡片
    ├── boxes/               # 测试箱子
    └── files/               # 测试文件
```

### 6.1 单元测试示例

```typescript
// tests/unit/core/CardRenderer.test.ts
import { CardRenderer } from '@/core/viewer/CardRenderer';
import { PluginManager } from '@/core/plugins/PluginManager';
import { ThemeManager } from '@/core/viewer/ThemeManager';

describe('CardRenderer', () => {
  let renderer: CardRenderer;
  let pluginManager: PluginManager;
  let themeManager: ThemeManager;
  
  beforeEach(() => {
    pluginManager = new PluginManager(new EventBus());
    themeManager = new ThemeManager(new EventBus());
    renderer = new CardRenderer(pluginManager, themeManager);
  });
  
  it('should render a text card', async () => {
    const card: Card = {
      id: 'test-1',
      type: CardType.RichText,
      version: '1.0.0',
      metadata: {
        createdAt: Date.now(),
        modifiedAt: Date.now()
      },
      content: {
        text: 'Hello World'
      }
    };
    
    const container = document.createElement('div');
    await renderer.render(card, container);
    
    expect(container.innerHTML).toContain('Hello World');
  });
});
```

## 7. 文档结构

```
docs/
├── user-guide/               # 用户指南
│   ├── getting-started.md   # 快速开始
│   ├── viewing-cards.md     # 查看卡片
│   └── customization.md     # 自定义设置
│
├── developer-guide/          # 开发者指南
│   ├── architecture.md      # 架构说明
│   ├── plugin-development.md # 插件开发
│   └── contributing.md      # 贡献指南
│
└── api/                      # API 文档
    ├── viewer-api.md        # 查看器 API
    ├── plugin-api.md        # 插件 API
    └── types.md             # 类型定义
```

## 8. 开发工作流

### 8.1 开发模式

```bash
# 启动开发服务器
npm run dev

# 打开 DevTools
Ctrl+Shift+I (Windows/Linux)
Cmd+Option+I (macOS)
```

### 8.2 构建流程

```bash
# 开发构建
npm run build:dev

# 生产构建
npm run build

# 打包应用
npm run package

# 发布
npm run release
```

### 8.3 代码规范

```bash
# 代码检查
npm run lint

# 自动修复
npm run lint:fix

# 格式化代码
npm run format

# 类型检查
npm run type-check
```

## 9. 总结

Chips Viewer 的代码结构遵循以下原则：

1. **模块化**：功能模块清晰分离
2. **可维护**：代码组织清晰,易于理解
3. **可扩展**：插件系统支持功能扩展
4. **可测试**：完善的测试覆盖
5. **规范化**：统一的代码风格和命名规范

通过良好的代码结构,Chips Viewer 能够保持高质量的代码库,便于团队协作和长期维护。

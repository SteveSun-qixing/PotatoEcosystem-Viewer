# Phase 2: 核心模块开发

**阶段目标**：实现核心业务模块，完成卡片和箱子的打开和显示功能  
**预计工期**：7天  
**开发模式**：顺序开发（确保核心功能稳定）

---

## 任务清单

### 任务 2.1：ViewerApp 主类实现（1.5天）

#### 2.1.1 ViewerApp 核心类

**描述**：实现 Viewer 应用的主控制类，作为整个应用的入口点

**文件**：`src/renderer/core/viewer/ViewerApp.ts`

**类设计**：

```typescript
/**
 * ViewerApp - 查看器应用主类
 * 
 * 职责：
 * 1. 管理应用生命周期
 * 2. 协调各个子模块
 * 3. 提供统一的 API 入口
 */
export class ViewerApp implements IViewerApp {
  // 状态
  private _state: ViewerState = 'idle';
  private _currentContent: CurrentContent;
  
  // 子模块
  private cardManager: ICardManager;
  private boxManager: IBoxManager;
  private navigationController: INavigationController;
  private pluginManager: IPluginManager;
  private themeManager: IThemeManager;
  private configManager: IConfigManager;
  
  // 事件系统
  private eventBus: IEventBus;
  private logger: ILogger;
  
  constructor(options?: ViewerAppOptions);
  
  // 生命周期
  async initialize(): Promise<void>;
  destroy(): Promise<void>;
  
  // 状态访问
  get state(): ViewerState;
  get isReady(): boolean;
  get currentContent(): CurrentContent;
  
  // 内容操作
  async openCard(path: string, options?: Partial<CardRenderOptions>): Promise<void>;
  async openBox(path: string, options?: Partial<BoxRenderOptions>): Promise<void>;
  closeContent(): void;
  
  // 导航
  navigate(target: NavigationTarget): Promise<void>;
  goBack(): void;
  goForward(): void;
  canGoBack(): boolean;
  canGoForward(): boolean;
  
  // 事件
  on<T>(event: string, handler: (data: T) => void): string;
  off(event: string, handlerId?: string): void;
  emit(event: string, data?: unknown): void;
  
  // 快捷方法
  setTheme(themeId: string): void;
  getConfig<T>(key: string, defaultValue?: T): T;
  setConfig(key: string, value: unknown): void;
}
```

**实现要点**：
1. 使用单例模式或依赖注入
2. 状态机管理应用状态
3. 异步初始化各子模块
4. 统一错误处理

**验收标准**：
- [ ] ViewerApp 类实现完整
- [ ] 生命周期方法正常工作
- [ ] 状态转换正确
- [ ] 单元测试覆盖率 ≥ 90%

---

#### 2.1.2 ViewerApp 选项和配置

**描述**：定义 ViewerApp 的配置选项

**文件**：`src/renderer/core/viewer/types.ts`

```typescript
/**
 * ViewerApp 配置选项
 */
export interface ViewerAppOptions {
  // 基础配置
  platform?: Platform;
  language?: string;
  theme?: ThemeType;
  
  // 插件配置
  plugins?: {
    autoLoad?: boolean;
    enableBuiltin?: boolean;
    customPaths?: string[];
  };
  
  // 渲染配置
  rendering?: {
    defaultMode?: RenderMode;
    lazyLoad?: boolean;
    cacheSize?: number;
  };
  
  // 导航配置
  navigation?: {
    enableHistory?: boolean;
    maxHistory?: number;
  };
  
  // 调试配置
  debug?: boolean;
}

/**
 * ViewerApp 初始化结果
 */
export interface InitializeResult {
  success: boolean;
  duration: number;
  errors?: string[];
}
```

**验收标准**：
- [ ] 类型定义完整
- [ ] 配置选项合理

---

### 任务 2.2：CardManager 卡片管理器（1.5天）

#### 2.2.1 CardManager 实现

**描述**：实现卡片管理器，负责卡片的加载和渲染调度

**文件**：`src/renderer/core/viewer/CardManager.ts`

**类设计**：

```typescript
/**
 * CardManager - 卡片管理器
 * 
 * 职责：
 * 1. 加载卡片文件
 * 2. 调用 Foundation 的 CardRenderer 进行渲染
 * 3. 管理当前打开的卡片
 * 4. 处理渲染结果
 */
export class CardManager implements ICardManager {
  private currentCard: Card | null = null;
  private currentFrame: HTMLIFrameElement | null = null;
  private sdkService: SDKService;
  private logger: ILogger;
  private eventBus: IEventBus;
  
  constructor(sdkService: SDKService, eventBus: IEventBus);
  
  /**
   * 打开卡片
   * @param path 卡片文件路径
   * @param container 渲染容器
   * @param options 渲染选项
   */
  async openCard(
    path: string, 
    container: HTMLElement, 
    options?: Partial<CardRenderOptions>
  ): Promise<CardRenderResult>;
  
  /**
   * 关闭当前卡片
   */
  closeCard(): void;
  
  /**
   * 获取当前卡片
   */
  getCurrentCard(): Card | null;
  
  /**
   * 获取卡片元数据
   */
  async getCardMetadata(path: string): Promise<CardMetadata>;
  
  /**
   * 验证卡片文件
   */
  async validateCard(path: string): Promise<boolean>;
  
  /**
   * 刷新当前卡片
   */
  async refreshCard(): Promise<void>;
  
  /**
   * 缩放卡片
   */
  setZoom(zoom: number): void;
  
  /**
   * 获取当前缩放
   */
  getZoom(): number;
  
  // 私有方法
  private async loadCard(path: string): Promise<Card>;
  private async renderCard(card: Card, container: HTMLElement, options: CardRenderOptions): Promise<CardRenderResult>;
  private cleanupCurrentCard(): void;
  private setupInteractionChannel(frame: HTMLIFrameElement): void;
}
```

**实现要点**：
1. 通过 SDK 加载卡片数据
2. 通过内核路由调用 Foundation 的 CardRenderer
3. 管理 iframe 生命周期
4. 建立与 iframe 的通信通道

**关键代码示例**：

```typescript
async openCard(
  path: string, 
  container: HTMLElement, 
  options?: Partial<CardRenderOptions>
): Promise<CardRenderResult> {
  this.logger.info('Opening card', { path });
  
  try {
    // 1. 清理当前卡片
    this.cleanupCurrentCard();
    
    // 2. 加载卡片数据
    const card = await this.loadCard(path);
    this.currentCard = card;
    
    // 3. 构建渲染选项
    const renderOptions: CardRenderOptions = {
      cardId: card.id,
      containerId: container.id,
      mode: options?.mode ?? 'full',
      themeId: options?.themeId,
      interactive: options?.interactive ?? true,
      autoHeight: options?.autoHeight ?? true,
    };
    
    // 4. 通过内核路由调用 CardRenderer
    const result = await this.sdkService.request<CardRenderResult>(
      'foundation.card.render',
      { cardData: card, options: renderOptions }
    );
    
    if (result.success && result.frame) {
      // 5. 挂载 iframe
      container.appendChild(result.frame);
      this.currentFrame = result.frame;
      
      // 6. 建立交互通道
      this.setupInteractionChannel(result.frame);
      
      // 7. 发布事件
      this.eventBus.emit(EVENTS.CONTENT_RENDER, {
        type: 'card',
        path,
        success: true,
        duration: result.duration,
      });
    }
    
    return result;
  } catch (error) {
    this.logger.error('Failed to open card', error as Error);
    
    this.eventBus.emit(EVENTS.CONTENT_ERROR, {
      type: 'card',
      path,
      error: (error as Error).message,
    });
    
    return {
      success: false,
      error: (error as Error).message,
    };
  }
}
```

**验收标准**：
- [ ] CardManager 类实现完整
- [ ] 卡片加载和渲染正常
- [ ] iframe 管理正确
- [ ] 错误处理完善
- [ ] 单元测试覆盖率 ≥ 90%

---

### 任务 2.3：BoxManager 箱子管理器（1天）

#### 2.3.1 BoxManager 实现

**描述**：实现箱子管理器，负责箱子的加载和渲染调度

**文件**：`src/renderer/core/viewer/BoxManager.ts`

**类设计**：

```typescript
/**
 * BoxManager - 箱子管理器
 * 
 * 职责：
 * 1. 加载箱子文件
 * 2. 调用 Foundation 的 BoxRenderer 进行渲染
 * 3. 管理当前打开的箱子
 * 4. 处理布局切换
 */
export class BoxManager implements IBoxManager {
  private currentBox: Box | null = null;
  private currentFrame: HTMLIFrameElement | null = null;
  private sdkService: SDKService;
  private logger: ILogger;
  private eventBus: IEventBus;
  
  constructor(sdkService: SDKService, eventBus: IEventBus);
  
  /**
   * 打开箱子
   */
  async openBox(
    path: string, 
    container: HTMLElement, 
    options?: Partial<BoxRenderOptions>
  ): Promise<BoxRenderResult>;
  
  /**
   * 关闭当前箱子
   */
  closeBox(): void;
  
  /**
   * 获取当前箱子
   */
  getCurrentBox(): Box | null;
  
  /**
   * 获取箱子元数据
   */
  async getBoxMetadata(path: string): Promise<BoxMetadata>;
  
  /**
   * 验证箱子文件
   */
  async validateBox(path: string): Promise<boolean>;
  
  /**
   * 切换布局
   */
  async switchLayout(layoutId: string): Promise<void>;
  
  /**
   * 获取可用布局列表
   */
  getAvailableLayouts(): Array<{ id: string; name: string }>;
  
  /**
   * 打开箱子中的卡片
   */
  async openCardInBox(cardId: string): Promise<void>;
  
  // 私有方法
  private async loadBox(path: string): Promise<Box>;
  private async renderBox(box: Box, container: HTMLElement, options: BoxRenderOptions): Promise<BoxRenderResult>;
  private cleanupCurrentBox(): void;
}
```

**验收标准**：
- [ ] BoxManager 类实现完整
- [ ] 箱子加载和渲染正常
- [ ] 布局切换功能正常
- [ ] 单元测试覆盖率 ≥ 90%

---

### 任务 2.4：NavigationController 导航控制器（1天）

#### 2.4.1 NavigationController 实现

**描述**：实现导航控制器，管理浏览历史和导航功能

**文件**：`src/renderer/core/viewer/NavigationController.ts`

**类设计**：

```typescript
/**
 * NavigationController - 导航控制器
 * 
 * 职责：
 * 1. 管理浏览历史
 * 2. 实现前进/后退功能
 * 3. 管理滚动位置
 * 4. 持久化历史记录
 */
export class NavigationController implements INavigationController {
  private history: NavigationHistoryEntry[] = [];
  private currentIndex: number = -1;
  private maxHistory: number;
  private eventBus: IEventBus;
  private logger: ILogger;
  
  constructor(options: NavigationControllerOptions);
  
  /**
   * 导航到目标
   */
  async navigate(target: NavigationTarget): Promise<void>;
  
  /**
   * 后退
   */
  goBack(): void;
  
  /**
   * 前进
   */
  goForward(): void;
  
  /**
   * 是否可以后退
   */
  canGoBack(): boolean;
  
  /**
   * 是否可以前进
   */
  canGoForward(): boolean;
  
  /**
   * 获取历史记录
   */
  getHistory(): NavigationHistoryEntry[];
  
  /**
   * 获取当前条目
   */
  getCurrentEntry(): NavigationHistoryEntry | null;
  
  /**
   * 清除历史
   */
  clearHistory(): void;
  
  /**
   * 跳转到历史记录中的指定位置
   */
  goTo(index: number): void;
  
  /**
   * 保存滚动位置
   */
  saveScrollPosition(position: { x: number; y: number }): void;
  
  /**
   * 恢复滚动位置
   */
  restoreScrollPosition(): { x: number; y: number } | null;
  
  // 私有方法
  private addToHistory(entry: NavigationHistoryEntry): void;
  private trimHistory(): void;
  private persistHistory(): void;
  private loadHistory(): void;
}
```

**实现要点**：
1. 使用数组实现历史栈
2. 支持历史记录截断
3. 本地存储持久化
4. 滚动位置管理

**验收标准**：
- [ ] NavigationController 类实现完整
- [ ] 前进后退功能正常
- [ ] 历史记录持久化
- [ ] 单元测试覆盖率 ≥ 90%

---

### 任务 2.5：StateManager 状态管理（1天）

#### 2.5.1 Pinia Store 定义

**描述**：使用 Pinia 实现状态管理

**文件**：`src/renderer/store/viewer.ts`

```typescript
/**
 * Viewer 状态管理
 */
import { defineStore } from 'pinia';
import type { 
  ViewerState, 
  CurrentContent, 
  ViewOptions,
  NavigationHistoryEntry 
} from '@common/types';

export interface ViewerStoreState {
  // 应用状态
  state: ViewerState;
  error: string | null;
  
  // 当前内容
  currentContent: CurrentContent;
  
  // 视图选项
  viewOptions: ViewOptions;
  
  // 导航
  navigationHistory: NavigationHistoryEntry[];
  currentHistoryIndex: number;
  
  // 主题
  currentTheme: string;
  
  // 侧边栏
  sidebarVisible: boolean;
  sidebarWidth: number;
  
  // 加载状态
  isLoading: boolean;
  loadingMessage: string;
}

export const useViewerStore = defineStore('viewer', {
  state: (): ViewerStoreState => ({
    state: 'idle',
    error: null,
    currentContent: {
      type: 'none',
      data: null,
      path: null,
      renderResult: null,
    },
    viewOptions: {
      zoom: 1,
      fitMode: 'auto',
      showSidebar: true,
      showToolbar: true,
      showStatusBar: true,
    },
    navigationHistory: [],
    currentHistoryIndex: -1,
    currentTheme: 'system',
    sidebarVisible: true,
    sidebarWidth: 280,
    isLoading: false,
    loadingMessage: '',
  }),
  
  getters: {
    isReady: state => state.state === 'ready',
    hasContent: state => state.currentContent.type !== 'none',
    canGoBack: state => state.currentHistoryIndex > 0,
    canGoForward: state => state.currentHistoryIndex < state.navigationHistory.length - 1,
    currentEntry: state => state.navigationHistory[state.currentHistoryIndex] ?? null,
  },
  
  actions: {
    // 状态管理
    setState(newState: ViewerState): void {
      this.state = newState;
    },
    
    setError(error: string | null): void {
      this.error = error;
      if (error) {
        this.state = 'error';
      }
    },
    
    // 内容管理
    setCurrentContent(content: CurrentContent): void {
      this.currentContent = content;
    },
    
    clearContent(): void {
      this.currentContent = {
        type: 'none',
        data: null,
        path: null,
        renderResult: null,
      };
    },
    
    // 视图选项
    setZoom(zoom: number): void {
      this.viewOptions.zoom = Math.max(0.1, Math.min(5, zoom));
    },
    
    setFitMode(mode: ViewOptions['fitMode']): void {
      this.viewOptions.fitMode = mode;
    },
    
    toggleSidebar(): void {
      this.sidebarVisible = !this.sidebarVisible;
    },
    
    setSidebarWidth(width: number): void {
      this.sidebarWidth = Math.max(200, Math.min(500, width));
    },
    
    // 导航
    addToHistory(entry: NavigationHistoryEntry): void {
      // 清除当前位置之后的历史
      this.navigationHistory = this.navigationHistory.slice(0, this.currentHistoryIndex + 1);
      this.navigationHistory.push(entry);
      this.currentHistoryIndex = this.navigationHistory.length - 1;
    },
    
    goToHistoryIndex(index: number): void {
      if (index >= 0 && index < this.navigationHistory.length) {
        this.currentHistoryIndex = index;
      }
    },
    
    clearHistory(): void {
      this.navigationHistory = [];
      this.currentHistoryIndex = -1;
    },
    
    // 主题
    setTheme(theme: string): void {
      this.currentTheme = theme;
    },
    
    // 加载状态
    setLoading(loading: boolean, message?: string): void {
      this.isLoading = loading;
      this.loadingMessage = message ?? '';
    },
  },
});
```

**验收标准**：
- [ ] Pinia store 定义完整
- [ ] 状态结构合理
- [ ] actions 实现正确
- [ ] getters 计算正确

---

#### 2.5.2 配置状态管理

**描述**：实现配置状态管理

**文件**：`src/renderer/store/config.ts`

```typescript
/**
 * 配置状态管理
 */
import { defineStore } from 'pinia';
import type { ViewerConfig } from '@common/types';
import { DEFAULT_CONFIG, CACHE_KEYS } from '@common/constants';

export const useConfigStore = defineStore('config', {
  state: (): ViewerConfig => ({ ...DEFAULT_CONFIG }),
  
  actions: {
    // 加载配置
    async loadConfig(): Promise<void> {
      try {
        const stored = localStorage.getItem(CACHE_KEYS.USER_CONFIG);
        if (stored) {
          const config = JSON.parse(stored);
          this.$patch(config);
        }
      } catch (error) {
        console.error('Failed to load config:', error);
      }
    },
    
    // 保存配置
    async saveConfig(): Promise<void> {
      try {
        const config = this.$state;
        localStorage.setItem(CACHE_KEYS.USER_CONFIG, JSON.stringify(config));
      } catch (error) {
        console.error('Failed to save config:', error);
      }
    },
    
    // 更新配置
    updateConfig<K extends keyof ViewerConfig>(key: K, value: ViewerConfig[K]): void {
      this[key] = value;
      this.saveConfig();
    },
    
    // 重置配置
    resetConfig(): void {
      this.$patch(DEFAULT_CONFIG);
      this.saveConfig();
    },
  },
});
```

**验收标准**：
- [ ] 配置 store 定义完整
- [ ] 本地存储持久化
- [ ] 配置更新和重置正常

---

### 任务 2.6：ConfigManager 配置管理（1天）

#### 2.6.1 ConfigManager 实现

**描述**：实现配置管理器，支持多层级配置

**文件**：`src/renderer/core/viewer/ConfigManager.ts`

```typescript
/**
 * ConfigManager - 配置管理器
 * 
 * 支持多层级配置：默认配置 < 用户配置 < 运行时配置
 */
export class ConfigManager implements IConfigManager {
  private defaultConfig: ViewerConfig;
  private userConfig: Partial<ViewerConfig> = {};
  private runtimeConfig: Partial<ViewerConfig> = {};
  private changeHandlers: Map<string, Array<(newValue: unknown, oldValue: unknown) => void>> = new Map();
  private logger: ILogger;
  
  constructor(defaultConfig?: Partial<ViewerConfig>);
  
  /**
   * 获取配置值
   */
  get<T>(key: string, defaultValue?: T): T;
  
  /**
   * 设置配置值（运行时）
   */
  set(key: string, value: unknown): void;
  
  /**
   * 设置用户配置
   */
  setUserConfig(key: string, value: unknown): void;
  
  /**
   * 获取完整配置
   */
  getAll(): ViewerConfig;
  
  /**
   * 重置运行时配置
   */
  reset(): void;
  
  /**
   * 保存用户配置到本地存储
   */
  async save(): Promise<void>;
  
  /**
   * 从本地存储加载用户配置
   */
  async load(): Promise<void>;
  
  /**
   * 监听配置变化
   */
  onChange(key: string, handler: (newValue: unknown, oldValue: unknown) => void): void;
  
  /**
   * 取消监听
   */
  offChange(key: string, handler?: (newValue: unknown, oldValue: unknown) => void): void;
  
  // 私有方法
  private mergeConfig(): ViewerConfig;
  private getNestedValue(obj: unknown, path: string): unknown;
  private setNestedValue(obj: Record<string, unknown>, path: string, value: unknown): void;
  private notifyChange(key: string, newValue: unknown, oldValue: unknown): void;
}
```

**验收标准**：
- [ ] ConfigManager 类实现完整
- [ ] 多层级配置合并正确
- [ ] 变更通知功能正常
- [ ] 持久化功能正常
- [ ] 单元测试覆盖率 ≥ 90%

---

### 任务 2.7：核心模块集成测试（0.5天）

#### 2.7.1 集成测试

**描述**：编写核心模块的集成测试

**文件**：`tests/integration/core.test.ts`

```typescript
/**
 * 核心模块集成测试
 */
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { ViewerApp } from '@renderer/core/viewer/ViewerApp';
import { sdkService } from '@renderer/services';

describe('ViewerApp Integration', () => {
  let app: ViewerApp;
  
  beforeEach(async () => {
    await sdkService.initialize({ debug: true });
    app = new ViewerApp();
    await app.initialize();
  });
  
  afterEach(async () => {
    await app.destroy();
    sdkService.destroy();
  });
  
  describe('Card Operations', () => {
    it('should open a card file', async () => {
      const container = document.createElement('div');
      await app.openCard('/test/sample.card', { container });
      
      expect(app.currentContent.type).toBe('card');
      expect(app.currentContent.data).not.toBeNull();
    });
    
    it('should close card properly', async () => {
      const container = document.createElement('div');
      await app.openCard('/test/sample.card', { container });
      app.closeContent();
      
      expect(app.currentContent.type).toBe('none');
      expect(app.currentContent.data).toBeNull();
    });
  });
  
  describe('Navigation', () => {
    it('should maintain navigation history', async () => {
      const container = document.createElement('div');
      await app.navigate({ type: 'card', path: '/test/card1.card' });
      await app.navigate({ type: 'card', path: '/test/card2.card' });
      
      expect(app.canGoBack()).toBe(true);
      expect(app.canGoForward()).toBe(false);
      
      app.goBack();
      expect(app.canGoForward()).toBe(true);
    });
  });
});
```

**验收标准**：
- [ ] 集成测试编写完成
- [ ] 所有测试通过
- [ ] 覆盖主要功能场景

---

## 阶段完成标准

### 必须完成项

- [ ] ViewerApp 主类实现完成
- [ ] CardManager 实现完成
- [ ] BoxManager 实现完成
- [ ] NavigationController 实现完成
- [ ] StateManager (Pinia) 实现完成
- [ ] ConfigManager 实现完成
- [ ] 可以打开并显示卡片文件
- [ ] 可以打开并显示箱子文件
- [ ] 导航功能正常

### 质量要求

- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 集成测试通过
- [ ] TypeScript 类型检查通过
- [ ] ESLint 检查通过
- [ ] 代码注释完整

### 提交记录

完成后应有以下 Git 提交：
1. `feat: 实现 ViewerApp 主类`
2. `feat: 实现 CardManager 卡片管理器`
3. `feat: 实现 BoxManager 箱子管理器`
4. `feat: 实现 NavigationController 导航控制器`
5. `feat: 实现 Pinia 状态管理`
6. `feat: 实现 ConfigManager 配置管理`
7. `test: 添加核心模块集成测试`

---

**下一阶段**：Phase 3 - 插件系统与渲染集成
